---
title: "Participation in Financial Rulemaking"
#subtitle: "Appendix and Replication Code" 
output:
    bookdown::html_document2:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
      number_sections: false
# output:
#   xaringan::moon_reader:
#     lib_dir: libs
#     mathjax: "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"
#     css: xaringan-themer.css
#     nature:
#       highlightStyle: github
#       highlightLines: true
#       countIncrementalSlides: false
---



```{r options, include=FALSE}
# rmarkdown::render("docs/participation.Rmd")

## Sets defaults for R chunks
knitr::opts_chunk$set(echo = FALSE, # echo = TRUE means that code will show
                      cache = FALSE,
                      #cache = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.show="hold",
                      fig.pos= "htbp",
                      fig.path = "figs/",
                      fig.align='center',
                      fig.cap = '   ',
                      fig.retina = 6,
                      fig.height = 3,
                      fig.width = 7,
                      out.width = "100%",
                      out.extra = "")

library("xaringan")
library("xaringanthemer")
library("here")


style_mono_light(base_color = "#3b444b",
          link_color = "#B7E4CF",
          #background_color = "#FAF0E6", # linen
          header_font_google = google_font("PT Sans"), 
          text_font_google = google_font("Old Standard"), 
          text_font_size = "18px",
          padding = "10px",
          code_font_google = google_font("Inconsolata"), 
          code_inline_background_color    = "#F5F5F5", 
          table_row_even_background_color = "#ddede5",
          extra_css = 
            list(".remark-slide-number" = list("display" = "none")))
```

```{r setup}
options(scipen=999)


library(scales)
library(magrittr)
library(broom)
library(dotwhisker)
library(here)
library(knitr)
library(kableExtra)
library(lmerTest)
library(fixest)
library(modelsummary)
library(tidyverse)

# defaults for plots
library(ggplot2); theme_set(theme_minimal());
options(
  ggplot2.continuous.color = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_color_discrete <- function(...){
  scale_color_viridis_d(..., direction = -1, 
                        begin = 0, end = .6, option = "plasma")}
scale_fill_discrete <- function(...){
  scale_fill_viridis_d(..., direction = -1, 
                       begin = 0, end = .6, option = "plasma")}

scale_color_continuous <- function(...){
  scale_color_viridis_c(..., direction = -1, 
                        option = "plasma")}
scale_fill_continuous <- function(...){
  scale_fill_viridis_c(..., direction = -1, 
                       option = "plasma")}

# Table formatting
library(kableExtra)
kablebox <- . %>% 
  slice_head(n = 100) %>%
  knitr::kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "400px")
```

# Data

# Commenters matched to other datasets of known organizations

```{r match_data}
load(here("data", "match_data_clean.Rdata"))

d <- match_data_clean

# 2k
 paste("Credit Union matches: ", sum(!is.na(d$CreditUnions_name)) )

d %>% filter(!is.na(CreditUnions_name)) %>% select(ends_with("name"), comment_url) %>% kablebox()

# 5k
 paste("CIK matches: ", sum(!is.na(d$CIK_name)) )

d %>% filter(!is.na(CIK_name)) %>% select(ends_with("name"), comment_url)  %>% kablebox()

# 1k
 paste("FDIC_Institutions matches: ", sum(!is.na(d$FDIC_Institutions_name)) )

d %>% filter(!is.na(FDIC_Institutions_name)) %>% select(ends_with("name"), comment_url) %>% kablebox()

# 0
 paste("FFIECInstitutions matches: ", sum(!is.na(d$FFIECInstitutions_name)) )

#d %>% filter(!is.na(FFIECInstitutions_name)) %>% select(ends_with("name")) %>% kablebox()

# 18k
 paste("NonProfitTax matches: ", sum(!is.na(d$NonProfitTax_name)) )

d %>% filter(!is.na(NonProfitTax_name)) %>% select(ends_with("name"), comment_url) %>% kablebox()

# 4k
 paste("OpenSecrets matches: ", sum(!is.na(d$OpenSecretsOrgs_name)) )

d %>% filter(!is.na(OpenSecretsOrgs_name)) %>% select(ends_with("name"), comment_url) %>% kablebox()


# 0
 paste("SEC matches: ", sum(!is.na(d$SEC_Institutions_name)))

# d %>% filter(!is.na(SEC_Institutions_name)) %>% select(ends_with("name"))  %>% kablebox()
 

```


```{r, eval=FALSE}
#Example urls

d %>% group_by(comment_agency) %>% 
  slice(1) %>% 
  select(comment_url)
```

---

# Number of comments by organization type 

```{r org_count_type}
d %<>% mutate(org_comment = ifelse(is_likely_org == 1, "Likely Org", "Likely Not Org"),
              Agency = str_to_upper(comment_agency))

d %>% group_by(Agency, org_type, org_comment) %>% 
  count() %>% 
  ggplot() +
  aes(x = Agency, y = n, fill = org_type) + 
  geom_col() + 
  facet_wrap("org_comment", scales = "free") +
  labs(fill = "")

org_count_agency <- d %>% filter(is_likely_org ==1) %>% 
  count(org_name, org_type, org_resources, Agency)

org_count <- d %>% filter(is_likely_org ==1) %>% 
  count(org_name, org_type, org_resources)
```

---

#  Number of comments by organization resources

---

## By Assets

(FDIC data)

### Among firms that commented on a Dodd Frank rule

```{r fdic_count, fig.width=4, out.width= "50%"}
max <- org_count %>%   filter(org_type == "FDIC") %>% pull(n) %>% max()

org_count %>% 
  filter(org_type == "FDIC") %>% 
  ggplot() +
  aes(x = org_resources,
      y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() +
  labs(x = "Assets",
       y = "Number of Comments") +
  lims(y =c(0, max))+ 
  scale_x_log10(breaks = breaks_log())

# by agency
max <- org_count_agency %>%   filter(org_type == "FDIC") %>% pull(n) %>% max()

org_count_agency %>% 
  filter(org_type == "FDIC") %>% 
  ggplot() +
  aes(x = org_resources,
      y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() +
  labs(x = "Assets",
       y = "Number of Comments") +
  lims(y =c(0, max)) + 
    facet_wrap("Agency") + 
  scale_x_log10(breaks = breaks_log())
```

---

### Comparing firms that did and did not comment on Dodd-Frank rules


```{r FDIC-density, fig.width=6, out.width="50%"}
load(here("data", "FDIC_resources.Rdata"))

FDIC_resources %>% 
  #filter(assets > 100) %>% 
  mutate(Commented = ifelse(commented, "Commented", "Did not comment")) %>%
  ggplot() + 
  aes(x = ASSET, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(fill = "", x = "Assets")
```

---

### Among nonprofits that commented on Dodd-Frank rules

```{r nonprofit-count, fig.width=4, out.width="50%"}
load(here("data", "nonprofit_resources.Rdata"))

nonprofit_resources %>% 
  filter(commented, assets > 100) %>% 
  ggplot() + 
  aes(x = assets, y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() + 
    labs(x = "Assets",
       y = "Number of Comments") +
  scale_x_log10()


nonprofit_resources %>% 
  filter(commented, assets > 100) %>% 
  ggplot() + 
  aes(x = revenue, y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() + 
    labs(x = "Revenue",
       y = "Number of Comments") +
  scale_x_log10() 
```

---

### Comparing nonprofits that did and did not comment on Dodd-Frank rules

```{r nonprofit-density, fig.width=6, out.width="50%"}
load(here("data", "nonprofit_resources.Rdata"))

nonprofit_resources %>% 
  #filter(assets > 100) %>% 
  mutate(Commented = ifelse(commented, "Commented", "Did not comment")) %>%
  ggplot() + 
  aes(x = assets, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(fill = "", x = "Assets")

nonprofit_resources %>% 
  #filter(assets > 100) %>% 
  mutate(Commented = ifelse(commented, "Commented", "Did not comment")) %>%
  ggplot() + 
  aes(x = revenue, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(fill = "", x = "Revenue")

# CHARTS 
# - who comments, who does not 
# - 


# TODO 
# - biggest nonprofits by assets and revenue (e.eg. chamber )
# - compartaitve ratios at key levels
# - percent nonprofits 
# - side by side histograms
# missing fed in matching, but could compare FDIC regulator to agency commented on
# - scholzman and verba, gilens and bartels 
```



---

## By Lobbying Spending

(OpenSecrets data)

> TODO

---

## By Market Cap

(Computstat data)



