---
title: "Participation in Financial Rulemaking"
#subtitle: "Appendix and Replication Code"
output:
    bookdown::html_document2:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
      number_sections: false
---

```{r options, include=FALSE}
# rmarkdown::render("docs/participation.Rmd")
source(here::here("code", "setup.R"))

## Change defaults for R chunks
knitr::opts_chunk$set(cache = FALSE,
                      fig.path = "../figs/",
                      fig.retina = 1, #6, #FIXME for publication quality images 
                      fig.height = 3,
                      fig.width = 7)
```


# Data

```{r}
read_csv(here::here("data", "master_tables_status.csv")) %>% 
  mutate(attachments_table = replace_na(attachments_table, 0)) %>% 
  rename(`attachments table` = attachments_table,
         `efficacy and sophistication measures` =`term counts`) %>% 
  kablebox()
```

The root for this script is `finreg`. Most of the data are in `finreg/data` (some in a subfolder `merged_resources`). Others are up one level in `FINREGRULEMAKE2/Data`. This can and should be streamlined significantly. 

Rules and comments: 

- Agency actions: `finreg/data/actions.csv`
- RIN-level data: `finreg/data/dodd-frank-rulemaking-directory_doc_oriented_wdescription.xls` and `finreg/data/docket_related_rin_lookup.csv`
- Docket-level comment data: `finreg/data/matches_per_docket.csv`


Resource data: 
- For commenters: `finreg/data/match_data_clean.Rdata`

Resource data for full population of organizations, including non-commmenters: 

- Nonprofit `assets` and `revenue` from 990 data from https://www.irs.gov/charities-non-profits/form-990-series-downloads: `finreg/data/nonprofit_resources.Rdata` or `finreg/data/merged_resources/nonprofit_resources.csv`
- FDIC assets (`ASSET`) and bank class (`BKCLASS`): `finreg/data/FDIC_resources.Rdata` or `finreg/data/merged_resources/FDIC_Institutions.csv`
- Credit unions `Total Assets` scraped from consolidated call report files scraped from https://www.ncua.gov/analysis/credit-union-corporate-call-report-data by `acquisition/get_credit-Unions.py`: `Data/creditunions.csv` (up one level, not in finreg)
- Campaign donations (`MeanContribAmount` and `MeanContribAmount`) from https://www.opensecrets.org/: `finreg/data/merged_resources/opensecrets_resources_JwVersion.csv`
- Market capitalization (`marketcap`) from compustat? `Data/compustat_names.csv` and SEC's CIK database `Data/CIK.csv`: `finreg/data/merged_resources/compustat_resources.csv`

Sophistication and Efficacy Measures are described here: https://judgelord.github.io/finreg/efficacy

```{r action-data}
# actions 
actions <- read_csv(here("data" , "actions.csv"))

actions %>% distinct(docket_id) %>% nrow

library("readxl")

rins <- read_excel(here::here("data", "dodd-frank-rulemaking-directory_doc_oriented_wdescription.xls")) %>% 
  rename(docket_id = identifier)  %>% 
  dplyr::select(-"...1")

lookup <- read_csv(here::here("data", "docket_related_rin_lookup.csv")) %>% 
  dplyr::select(-"...1") %>% 
  mutate(across(everything(), str_squish))

rin_lookup <- full_join(rins, lookup, by = "docket_id", suffix = c(".directory", ".lookup")) %>% 
  mutate(title = str_to_title(title) %>% str_squish()) %>% 
  mutate(across(everything(), str_squish))
```

```{r actions, fig.width=7, fig.height=6, out.width="100%", fig.cap= "Dodd-Frank Act Implimenting Actions by Agency", cache=FALSE}
wide =  read.csv( here::here("data", "pivot_example.csv") )
n_rules <- nrow(wide)

long = read.csv( here::here("data", "actions.csv") )

long %<>% 
  mutate(year = publication_date %>% str_sub(1,4),
         Stage = stage  %>% 
           str_replace("ANPR", "Advance NPRM (ANPRM)") %>% 
           str_replace("^FINAL", "Final Rule") %>% 
           str_replace("GUIDANCE", "Guidance") %>% 
           str_replace("INTERIM-FINAL", "Interim Final Rule") %>% 
           str_replace("^NPR", "Notice of Proposed\nRulemaking (NPRM)")) %>% 
    group_by(agency_acronym) %>%
  add_count(name = "agency_total") %>% 
  ungroup()

n_actions <- nrow(long)

long %>% 
  filter(Stage %in% c("Advance NPRM (ANPRM)", "Final Rule", "Interim Final Rule", "Notice of Proposed\nRulemaking (NPRM)"),
         agency_acronym %in% c("FRS", "CFPB", "SEC", "CFTC", "FDIC", "OCC",  "NCUA") ) %>% 
  count(year, agency_acronym, Stage) %>% 
  ggplot() +
  aes(y = n, x = year, fill = Stage) %>% 
  geom_col(alpha = .8) + 
  facet_wrap("agency_acronym", scales = "free") +
  scale_fill_viridis_d() +
  labs(fill = "Document Type",
       x = "", 
       y = "",
       caption = "Dodd-Frank regulatory actions from  the Consumer Financial Protection Bureau (CFPB),
Commodity Futures Trading Commission (CFTC), Federal Deposit Insurance Corporation (FIDC), 
Federal Reserve (FRS), National Credit Union Administration (NCUA), 
Office of the Comptroler of the Currency (OCC), and Securities and Exchange Commission (SEC)") + 
  theme_minimal() +
  theme(axis.text.x = element_text(hjust = .7, angle = 60),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.caption = element_text(hjust = 0))
```

Some dockets don't have related rins in lookup table 
```{r rins-missing}
# ~35/2 with different comment counts per docket 
# ~325/2 with different titles per docket 
# ~98/2 with different related RINS / lowest related rin per docket 
# 115/2 with different docket_urls

# missing related RINs
rin_lookup %>% 
  dplyr::select(# title, 
    docket_id,
    RIN.directory, RIN.lookup,
         related.rins, 
         lowest.sorted.rin.of.related.rins, 
         docket_url.directory, docket_url.lookup,
             comment_count) %>%
  distinct() %>% 
  filter(is.na(related.rins)) %>% 
  kablebox()
```

## Dockets with more than one RIN

```{r rin-lookup}
rin_lookup %>% 
  dplyr::select(# title, 
    docket_id,
    RIN.directory, RIN.lookup,
         related.rins, 
         lowest.sorted.rin.of.related.rins, 
         docket_url.directory, docket_url.lookup,
             comment_count) %>%
  distinct() %>% 
  filter(!is.na(related.rins)) %>% 
  add_count( docket_id) %>%
  arrange(docket_id) %>% 
  filter(n > 1) %>%   
  distinct() %>% 
  kablebox()

rin_lookup %<>% 
  dplyr::select(-RIN.directory,
         -docket_url.directory) %>% distinct()

names(rin_lookup) %<>% str_remove(".lookup")
```

---

## Asset data

Summary table data here: 

```{r docket-table, fig.height=5.5, fig.width=5.4, out.width="80%"}
# clean match data from finreg_commenter_covariates
docket_table <- read_csv(here::here("data", "matches_per_docket.csv"))


docket_table %>% 
  add_count(Agency) %>% 
  mutate(Agency = paste(n, "dockets from", Agency)) %>% 
  dplyr::select(- Percent, - Docket, -`Any Resources Measure`) %>% 
  group_by(Agency) %>% 
  summarise_all(sum) %>% 
  group_by(Agency) %>% 
  pivot_longer(cols = c("Comments", contains(" ") ))  %>% 
  mutate(Matched = ifelse(name == "Comments", "Total","Matched"),
         name = ifelse(name == "Comments", "Total", name)) %>% 
  ggplot() + 
  aes(fill = name,
      y = Matched, 
      x = value) + 
    geom_col(position = "stack", alpha = .7) + 
  labs(x = "Comments", y = "", fill = "Resource\nData Type",
       title = "Comments Matched to Organizational Resources Data") + 
  facet_wrap("Agency", ncol = 1, scales = "free") + 
  theme(legend.position = "bottom",
        panel.grid.major.y = element_blank(),
        strip.text = element_text(size = 12)) 
```

### Dockets with most commments matched

```{r}
docket_table %<>% 
  arrange(-`Any Resources Measure`) 

# max
docket_table %>% 
  # filter(`Any Resources Measure` < 1) %>% 
  knitr::kable() %>% 
  kable_paper(full_width = F) %>%
  column_spec(5, color = "white",
              background = spec_color(docket_table$Comments/ docket_table$`Any Resources Measure`, begin = .1, end = .9, direction = 1, option = 3) ) %>% 
  scroll_box(height = "400px")
```

### Dockets with fewest commments matched
```{r}
docket_table %<>% 
  arrange(`Any Resources Measure`) 

# min
docket_table %>% 
  # filter(`Any Resources Measure` < 1) %>% 
  knitr::kable() %>% 
  kable_paper(full_width = F) %>%
  column_spec(5, color = "white",
              background = spec_color(docket_table$Comments/ docket_table$`Any Resources Measure`, begin = .1, end = .9, direction = 1, option = 3) ) %>% 
  scroll_box(height = "400px")
```


```{r data-match-clean}
# clean match data from finreg_commenter_covariates
load(here("data", "match_data_clean.Rdata"))

match_data_clean %>% count(comment_agency)

d <- match_data_clean  

#FIXME
d %<>% filter(org_name != "")

# make a numeric
d %<>%  
   mutate(marketcap = coalesce(`CIK-bestMatch:marketcap`, `compustat_resources-bestMatch:marketcap`) ) %>% 
  mutate(marketcap2 = ifelse(str_detect(marketcap, "k"),
                             marketcap %>% str_remove("k") %>% as.numeric() * 1000,
                             marketcap),
         marketcap2 = ifelse(str_detect(marketcap, "M"),
                             marketcap %>% str_remove("M") %>% as.numeric() * 1000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "B"),
                             marketcap %>% str_remove("B") %>% as.numeric() * 1000000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "T"),
                             marketcap %>% str_remove("T") %>% as.numeric() * 1000000000000,
                             marketcap2),
         marketcap2 = marketcap2 %>% str_remove(",") %>%  as.numeric(marketcap2))
```

## By organization type 

```{r org_count_type, fig.width=5.5, fig.height=2.3}
d %<>% mutate(#org_comment = ifelse(is_likely_org == 1, "Likely Org", "Likely Not Org"),
              Agency = str_to_upper(comment_agency))

#d %<>% filter(is_likely_org == 1)

#FIXME changing this 
d %<>% mutate(org_type = best_match_type)

d %<>% mutate(Org_type = org_type %>% 
                str_replace("CIK", "Filed with SEC (CIK Data)") %>% 
                str_replace("Compustat", "Wharton Compustat Company Database") %>% 
                str_replace("FDIC", "FDIC-Insured Bank") %>% 
                str_replace("Nonprofit", "Nonprofit (IRS Data)") %>% 
                str_replace("FFIEC", "FFIEC Bank/Bank-like Entity") %>% 
                str_replace("OpenSecrets", "PAC Donor (CRP Data)"))

# comments 
d %>% group_by(Agency, Org_type) %>% 
  count() %>% 
  ggplot() +
  aes(x = Agency, y = n, fill = Org_type) + 
  geom_col() + 
  labs(fill = "Type of Organanization",
       y = "Number of Comments")


# using best_match_type instead of org_type
#FIXME WHY IS THERE A DIFFERENCE
# d %>% 
#   mutate(Agency = str_spl(comment_agency, "\\|"),
#          org_type = Best_match_type %>% str_remove("_.*")) %>% 
#   unnest(Agency) %>%
#   group_by(Agency, org_type) %>% 
#   count() %>% 
#   ggplot() +
#   aes(x = Agency, y = n, fill = org_type) + 
#   geom_col() + 
#   #facet_wrap("org_comment", scales = "free") +
#   labs(fill = "Type of Organanization",
#        y = "Number of Comments")

# unique orgs 
d %>% nrow() 

d %>% distinct(org_name) %>% nrow() 

d %>% distinct(Agency, Org_type, org_name) %>% 
  group_by(Agency, Org_type) %>% 
  count() %>%
  ggplot() +
  aes(x = Agency, y = n, fill = Org_type) + 
  geom_col() + 
  labs(fill = "Type of Organanization",
       y = "Number of Organizations")


org_count_agency <- d %>% 
  count(org_name, org_type, org_resources, Agency)

org_count <- d  %>% 
  count(org_name, org_type, org_resources)
```

---

## Comments per docket

```{r rins-table}
d %>% count(Agency, docket_id) %>% 
  group_by(Agency) %>%
  summarise(mean_comments = mean(n),
            median_comments = median(n)) %>% 
  kablebox()



d_rin_lookup <- d %>% full_join(rin_lookup) %>% 
  distinct(docket_id,
         #  RIN,
         related.rins, 
         lowest.sorted.rin.of.related.rins, 
         #docket_url,  
         comment_count,
         comment_url) %>% 
  group_by(docket_id) %>%
  mutate(comments_matched = sum(!is.na(comment_url) ) ) %>% 
  mutate(comment_count = as.numeric(comment_count)) %>% 
  dplyr::select(docket_id, comment_count,comments_matched, everything()) %>% 
  arrange(docket_id) %>% 
  filter(!is.na(docket_id))

d_rin_lookup  %>% 
  dplyr::select(-comment_url) %>% 
  distinct() %>% 
  #filter(comments_matched > 0)
  kablebox()
```

Some of these appear to be over-matched, but it is also possible that the comment counts are wrong. 

```{r rins-table-comments-counts}
# 6 over matched 
d_rin_lookup %>% 
  filter(comment_count < comments_matched) %>%
  #arrange(comment_url) %>% 
  dplyr::select(-comment_url) %>% 
  distinct() %>% 
  kablebox()
```

---

### Payday loan rule

The payday loan rule accounts for 90% of credit union comments and 50% of nonprofit comments, and 75% of open secrets matched comments in the current data.
15% of nonprofits and 30% of opensecrets matches commented only on the payday loan rule

```{r org_count_type-payday, fig.width=7.5, fig.height=2.5}
d %<>% mutate(payday = ifelse(str_detect(comment_url, "CFPB-2016-0025|CFPB-2019-0006"), "Payday Loan Rules", "All Other Rules"))

d %>% group_by(Agency, Org_type, payday) %>% 
  count() %>% 
  ggplot() +
  aes(x = Agency, y = n, fill = Org_type) + 
  geom_col() + 
  labs(fill = "Type of Organanization",
       y = "Number of Comments") + 
  facet_wrap("payday")

# number of payday loan comments per org 
d %>% 
  #filter(payday == "Payday Loan Rules") %>% 
  count(comment_org_name, best_match_name, sort = T) %>% 
  kablebox() 

```

## Potential false matches

```{r false-matches}

false_match <- "nknown|private investor|private individual|self employed|american citizen|us citizen|advance america|b d | store 7|debt trap|financial 3|united states congress|lending bear|check city partnership|plan nevada|clarity services|title cash|st louis community credit union|antipoverty coalition greater dallas|faith fair lending|south carolina state senate|florida alliance consumer protection|minneapolis grain exchange|asset management group securities industry financial markets association|american title escrow|ssociation financial guaranty insurers|american financial services association|credit union association dakotas|working group commercial energy firms|center capital markets competitiveness|chelsea title nature coast|kendall county|california nevada credit union leagues|futures industry association fia|national rural electric cooperative association|pennsylvania housing finance agency|members congress|new york portfolio clearing|check city partnership|central title|committee on investment employee benefit assets|futures industry association|national association independent housing professionals"

# possible false positives
d %>% filter(str_detect(comment_org_name, false_match)) %>% nrow() %>% paste("potential false matches")

# false positive orgs 
d %>% filter(str_detect(comment_org_name, false_match)) %>% 
  count(comment_org_name, best_match_name, best_match_score, best_match_type, sort = T) %>% 
  #kable(format = "markdown")
  kablebox()

# false positive comments 
d %>% filter(str_detect(comment_org_name,  false_match)) %>% 
  dplyr::select(#starts_with("docket"), 
    starts_with("comment"),
         starts_with("best"), everything() ) %>% 
  dplyr::select(-comment_docket_count, -comment_agency) %>% 
  kablebox()


# drop false matches 
d %<>% filter(!str_detect(comment_org_name, false_match))


d %>% 
  filter(str_detect(best_match_name, "financial")) %>% 
  arrange(-org_comments) %>% 
  dplyr::select(org_comments, comment_org_name,  best_match_name, best_match_score, best_match_type, comment_url, everything()) %>% 
  kablebox()
```

---



## Commenters matched to other datasets of known organizations

```{r match_data}
# 2k
 paste("Credit Union matches: ", sum(!is.na(d$CreditUnions_name)) )

d %>% filter(!is.na(CreditUnions_name)) %>% dplyr::select(ends_with("name"), comment_url) %>% kablebox()

# 5k
 paste("CIK matches: ", sum(!is.na(d$CIK_name)) )

d %>% filter(!is.na(CIK_name)) %>% dplyr::select(ends_with("name"), comment_url)  %>% kablebox()

# 1k
 paste("FDIC_Institutions matches: ", sum(!is.na(d$FDIC_Institutions_name)) )

d %>% filter(!is.na(FDIC_Institutions_name)) %>% dplyr::select(ends_with("name"), comment_url) %>% kablebox()

# 0
 paste("FFIECInstitutions matches: ", sum(!is.na(d$FFIECInstitutions_name)) )

#d %>% filter(!is.na(FFIECInstitutions_name)) %>% dplyr::select(ends_with("name")) %>% kablebox()

# 18k
 paste("NonProfitTax matches: ", sum(!is.na(d$nonprofits_resources_name)) )

d %>% filter(!is.na(nonprofits_resources_name)) %>% dplyr::select(ends_with("name"), comment_url) %>% kablebox()

# 4k
 paste("OpenSecrets matches: ", sum(!is.na(d$opensecrets_resources_name)) )

d %>% filter(!is.na(opensecrets_resources_name)) %>% dplyr::select(ends_with("name"), comment_url) %>% kablebox()


# 0
 paste("SEC matches: ", sum(!is.na(d$SEC_Institutions_name)))

# d %>% filter(!is.na(SEC_Institutions_name)) %>% dplyr::select(ends_with("name"))  %>% kablebox()
 

```

Example Comment URLs
```{r, eval=TRUE}
#Example urls

d %>% group_by(Agency) %>% 
  slice(1) %>% 
  dplyr::select(docket_id, comment_url) %>% 
  kablebox()
```

---

# Participation by organization resources





## Comparing public companies that did and did not comment on Dodd-Frank rules


```{r FDIC-density, fig.height=1.5, fig.width=4, out.width="50%"}
#FDIC-density
# load(here("data", "FDIC_resources.Rdata"))

# CSVs for simplicity 
FDIC_resources <- read_csv(here::here("data", "merged_resources", "FDIC_Institutions.csv"))  %>%
  dplyr::select(NAME, NAMEHCR, STALP, STNAME, BKCLASS, ASSET) %>% 
  mutate(org_name = str_to_lower(NAME)) %>% 
  mutate(commented = org_name %in% d$best_match_name | org_name %in% d$FDIC_Institutions_name)


FDIC_resources %>% 
  #filter(assets > 100) %>% 
  mutate(Commented = ifelse(commented, "Commented", "Did not comment")) %>%
  ggplot() + 
  aes(x = ASSET/1000000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "FDIC-Insured Banks",
       fill = "", y = "", x = "Assets (Millions)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
```

Counts
```{r FDIC-count, fig.height=3, fig.width=4, out.width="50%"}
# FDIC-count
FDIC_resources %<>% 
  mutate(Commented = ifelse(
    org_name %in% d$best_match_name,
    "Commented", 
    "Did not comment")) 

# Dropping banks with less than $100
FDIC_resources %<>%  filter(ASSET > 1000) 


FDIC_resources%>% 
  ggplot() + 
  aes(x = ASSET/1000000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "FDIC-Insured Banks",
       fill = "", y = "", x = "Assets (Millions)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

FDIC_resources %<>% 
  filter(#BKCLASS != "N", 
         BKCLASS != "OI") %>%
  group_by(Commented) %>% 
  mutate(mean_ASSET = mean(ASSET, na.rm =TRUE),
         median_ASSET = median(ASSET, na.rm =TRUE)) %>% 
  ungroup() %>% 
  group_by(Commented, BKCLASS) %>% 
  mutate(mean_ASSET_type = mean(ASSET, na.rm =TRUE),
         median_ASSET_type = median(ASSET, na.rm =TRUE)) %>% 
  ungroup() 

FDIC_resources %>% distinct(Commented, mean_ASSET, median_ASSET) %>% kable()

FDIC_resources %>% distinct(Commented, BKCLASS, mean_ASSET_type, median_ASSET_type) %>% arrange(BKCLASS) %>% kablebox()


FDIC_resources %>%
  filter(ASSET > 10) %>% 
  mutate(Commented = Commented %>% paste0(         
    "\n(median = $", round(median_ASSET, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET, 0) %>% prettyNum(big.mark = ","), ")")) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET/1000)) + 
    geom_vline( aes(xintercept = median_ASSET/1000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = "All U.S. FDIC-Insured Banks",fill = "", y = "", x = "Assets (Thousands)") + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

---

### FDIC instituttions

#### National Associations

I am dropping National Associations for now because we are not matching some important ones, including JP Morgan Chase, Wells Fargo, Bank of America, CitiBank, PNC BANK, Capital One, U.S. Bank, TD Bank, and Chase Bank. 

This appears to be caused by commenting organizations matching to other FDIC classes (SA, SM, NM) or other datasets (mostly CIK). If the latter, this will hopefully be fixed when we allow matches across datasets, but if it is the former, and we only allow one match per dataset (as is appropriate), then we might need to think more about the best approach to matching these, perhaps selecting by largest assets.  

```{r FDIC-count-national-association, fig.height=3, fig.width=4, out.width="50%"}
#FDIC-count-national-association 

# class N
FDIC_resources %>% filter(BKCLASS == "N") %>% distinct(org_name, ASSET, Commented) %>% arrange(-ASSET) %>% kablebox()

# jpmorgan and wells fargo banks 
FDIC_resources %>% filter(str_detect(org_name, "jpmorgan|wells fargo|^bank of america|capital one|td bank|chase bank")) %>% distinct(BKCLASS, org_name, ASSET, Commented) %>% arrange(-ASSET) %>% kablebox()

# orgs in the comment data
d %>% filter(str_detect(org_name, "jpmorgan|wells fargo|^bank of america|capital one|td bank|chase bank")) %>% distinct(org_name, best_match_type, `FDIC_Institutions-bestMatch:ASSET`) %>% 
  kablebox()

FDIC_resources %>% count(Commented) %>% mutate(percent = n/nrow(FDIC_resources))

FDIC_resources %>% group_by(BKCLASS) %>%
  mutate(nbkclass = n() ) %>% count(Commented, nbkclass) %>% mutate(percent = n/nbkclass) 

fdic_t <- t.test(FDIC_resources %>% filter(commented) %>% pull(ASSET),
       FDIC_resources %>% filter(!commented) %>% pull(ASSET))
fdic_t

fdic_tNM <- t.test(FDIC_resources %>% filter(commented, BKCLASS == "NM") %>% pull(ASSET),
       FDIC_resources %>% filter(!commented, BKCLASS == "NM") %>% pull(ASSET))
fdic_tNM

fdic_tSM <- t.test(FDIC_resources %>% filter(commented, BKCLASS == "SM") %>% pull(ASSET),
       FDIC_resources %>% filter(!commented, BKCLASS == "SM") %>% pull(ASSET))
fdic_tSM 

fdic_tSB <- t.test(FDIC_resources %>% filter(commented, BKCLASS == "SB") %>% pull(ASSET),
       FDIC_resources %>% filter(!commented, BKCLASS == "SB") %>% pull(ASSET))
fdic_tSB

fdic_tSA <- t.test(FDIC_resources %>% filter(commented, BKCLASS == "SA") %>% pull(ASSET),
       FDIC_resources %>% filter(!commented, BKCLASS == "SA") %>% pull(ASSET))
fdic_tSA

FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("N")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
  scale_x_log10() + 
  labs(title = "FDIC-Insured National Associations",
       fill = "", y = "", x = "Assets (Thousands)") + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```


#### Dropping National Associations


Now omitting class national associations and foreign banks (Class IO are foreign banks and did not comment)

```{r FDIC-density-select, fig.height=1.5, fig.width=4, out.width="50%"}
#FDIC-density-select

FDIC_resources %<>% 
  filter(BKCLASS != "N", 
         BKCLASS != "OI") %>%
  group_by(Commented) %>% 
  mutate(mean_ASSET = mean(ASSET, na.rm =TRUE),
         median_ASSET = median(ASSET, na.rm =TRUE)) %>% 
  ungroup() %>% 
  group_by(Commented, BKCLASS) %>% 
  mutate(mean_ASSET_type = mean(ASSET, na.rm =TRUE),
         median_ASSET_type = median(ASSET, na.rm =TRUE)) %>% 
  ungroup() 


# density plot without N and OI
FDIC_resources %>% 
  #filter(assets > 100) %>% 
  mutate(Commented = ifelse(commented, "Commented", "Did not comment")) %>%
  ggplot() + 
  aes(x = ASSET/1000000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = str_c("FDIC-Insured Banks, N = ", nrow(FDIC_resources)%>% prettyNum(big.mark = ",")),
       fill = "", y = "", x = "Assets (Millions)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", fdic_t$p.value %>% round(3), "\nOmits foreign banks and national associations")) + 
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
```

```{r FDIC-count-select, fig.height=3, fig.width=4, out.width="50%"}

FDIC_resources %>% distinct(Commented, mean_ASSET) %>% kable()

FDIC_resources %>%
  filter(ASSET > 10) %>% 
  mutate(Commented = Commented %>% paste0(         
    "\n(median = $", round(median_ASSET/1000000, 2) , " million",
         ", mean = $", round(mean_ASSET/1000000, 1) %>% prettyNum(big.mark = ","), " million)")) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET/1000)) + 
    geom_vline( aes(xintercept = median_ASSET/1000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = str_c("U.S. FDIC-Insured Banks, N = ", nrow(FDIC_resources)%>% prettyNum(big.mark = ",")) ,
       fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", fdic_t$p.value %>% round(3), "\nOmits foreign banks and national associations")) + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

```{r FDIC-count-by-class, fig.height=3,  fig.width=4, out.width="49%"}
FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("NM")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
    geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
  scale_x_log10() + 
  labs(title = "FDIC-Insured Commercial Banks",fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", fdic_tNM$p.value %>% round(3)))  + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")

FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SB")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
    ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
  scale_x_log10() + 
  labs(title = "FDIC-Insured Savings Banks",fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", fdic_tSB$p.value %>% round(3)))  + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")


FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SM")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
    ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
scale_x_log10() + 
  labs(title = "FDIC-Insured State Banks",fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", fdic_tSM$p.value %>% round(3)))  + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")

FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SA")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
    ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
scale_x_log10() + 
  labs(title = "FDIC-Insured Savings Associations",fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", fdic_tSA$p.value %>% round(3)))  + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```


```{r fdic-map}
states <- map_data("state")

FDIC_state_n <- FDIC_resources %>% 
  mutate(region = STNAME %>% str_to_lower()) %>% 
  group_by(region) %>% 
  summarise(n = n() )

states %>% 
  left_join(FDIC_state_n) %>% 
  ggplot() +
  aes(long, lat, group = group, fill = n) +
  geom_polygon(color = "white") + 
  labs(fill = "FDIC-Insured Banks") +
  theme_void()


FDIC_state_n <- FDIC_resources %>% 
  mutate(region = STNAME %>% str_to_lower()) %>% 
  group_by(region) %>% 
  summarise(n = sum(Commented == "Commented"))

states %>% 
  left_join(FDIC_state_n) %>% 
  ggplot() +
  aes(long, lat, group = group, fill = n) +
  geom_polygon(color = "white") + 
  labs(fill = "FDIC-Insured Banks \nCommenting On\n Dodd-Frank Rules") +
  theme_void()


```


---

### Among nonprofits that commented on Dodd-Frank rules

```{r nonprofit-comment-counts, fig.height=1.5, fig.width=4, out.width="50%"}
load(here("data", "nonprofit_resources.Rdata"))

# make unique ( there are nearly 5k different rotary internationals, and sevarl APIs )
# select org entry with highest assets 
nonprofit_resources %<>% group_by(org_name) %>% 
  top_n(1, assets) %>% 
  ungroup()

nonprofit_resources %>% 
  filter(org_name %in% d$best_match_name) %>% 
  #filter(commented, assets > 100) %>% 
  ggplot() + 
  aes(x = assets, y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() + 
    labs(x = "Assets",
         title = str_c("Non-profits, N = ", nrow(nonprofit_resources)),
       y = "Number of Comments") +
  scale_x_log10()


nonprofit_resources %>% 
    filter(org_name %in% d$best_match_name) %>% 
  filter(commented, assets > 100) %>% 
  ggplot() + 
  aes(x = revenue, y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() + 
    labs(x = "Revenue",
         title = str_c("Non-profits, N = ", nrow(nonprofit_resources)),
       y = "Number of Comments") +
  scale_x_log10() 
```

---

### Comparing nonprofits that did and did not comment on Dodd-Frank rules

```{r nonprofit-density, fig.height= 1.5, fig.width=4, out.width="50%"}
# counts 
nonprofit_resources %<>% 
  mutate(Commented = ifelse(
    org_name %in% d$best_match_name,
    "Commented", 
    "Did not comment")) 

nonprofit_resources %>% count(Commented) %>% mutate(percent = n/nrow(nonprofit_resources))

nonprofit_t <- t.test(nonprofit_resources %>% filter(commented) %>% pull(assets),
       nonprofit_resources %>% filter(!commented) %>% pull(assets))

nonprofit_t

nonprofit_revenue_t <- t.test(nonprofit_resources %>% filter(commented) %>% pull(revenue),
       nonprofit_resources %>% filter(!commented) %>% pull(revenue))

nonprofit_revenue_t


# density plots 
nonprofit_resources %>% 
  filter(assets > 10) %>% 
  ggplot() + 
  aes(x = assets/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = str_c("Non-profits, N = ", nrow(nonprofit_resources)),
       fill = "", y = "", x = "Assets (Thoudsands)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", nonprofit_t$p.value %>% round(5)))  + 
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

nonprofit_resources %>% 
    filter(revenue > 10) %>% 
  ggplot() + 
  aes(x = revenue/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(fill = "", y = "", x = "Revenue (Thousands)",
       title = str_c("Non-profits, N = ", nrow(nonprofit_resources)),
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", nonprofit_revenue_t$p.value %>% round(5)))  + 
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())



nonprofit_resources %<>% 
  group_by(Commented) %>% 
  mutate(mean_assets = mean(assets, na.rm = T),
         median_assets = median(assets, na.rm = T),
         mean_revenue = median(revenue, na.rm = T)) %>% 
  ungroup()

nonprofit_resources %>% distinct(Commented, mean_assets, mean_revenue) %>% kable


# mean assets
mean_commented <- nonprofit_resources %>% filter(Commented == "Commented") %>% distinct(mean_assets/1000000) %>% round(1) %>%  paste("million")

mean_not_commented <- nonprofit_resources %>% filter(Commented != "Commented") %>% distinct(mean_assets/1000000) %>% round(1) %>%  paste("million")

# median assets
median_commented <- nonprofit_resources %>% filter(Commented == "Commented") %>% distinct(median_assets/1000000) %>% round(2) %>%  paste("million")

median_not_commented <- nonprofit_resources %>% filter(Commented != "Commented") %>% distinct(median_assets/1000000) %>% round(2) %>%  paste("million")
```


Nonprofits that commented on Dodd-Frank rules had an average of `r mean_commented` in assets, while nonprofits that did not comment averaged `r mean_not_commented`.

The median nonprofits that commented on Dodd-Frank rules had assets of `r median_commented` in assets, while the median nonprofit that did not comment had `r median_not_commented`.

```{r nonprofit-count, fig.height=3, fig.width=4, out.width="50%"}
#nonprofit-count  histograms 
nonprofit_resources %>% 
  filter(assets > 10) %>% 
  mutate(Commented = Commented %>% paste(
    "\n(median = $", round(median_assets/10000000, 2), " million, ",
    "mean = $", round(mean_assets/10000000, 1), " million)"
    )) %>% 
  ggplot() + 
  aes(x = assets/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_assets/1000)) + 
  geom_vline( aes(xintercept = median_assets/1000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = str_c("Non-profits, N = ", nrow(nonprofit_resources) %>% prettyNum(big.mark = ",") ),
       fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", nonprofit_t$p.value %>% round(5)))  + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")


nonprofit_resources %>% 
  filter(revenue > 10) %>% 
  ggplot() + 
  aes(x = revenue/1000, fill = Commented, label = mean_revenue) + 
  geom_histogram(alpha = .5, color = NA) + 
    geom_vline( aes(xintercept = mean_revenue/1000)) + 
  scale_x_log10() + 
  labs(title = str_c("Non-profits, N = ", nrow(nonprofit_resources)%>% prettyNum(big.mark = ",")),
       fill = "", y= "", x = "Revenue ($1,000s)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", nonprofit_revenue_t$p.value %>% round(5)))  + 
  facet_grid(Commented ~ ., scales = "free_y")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_blank(),
  strip.text.y = element_blank())

# CHARTS 
# - who comments, who does not 
# - 


# TODO 
# - biggest nonprofits by assets and revenue (e.eg. chamber )
# - compartaitve ratios at key levels
# - percent nonprofits 
# - side by side histograms
# missing fed in matching, but could compare FDIC regulator to agency commented on
# - scholzman and verba, gilens and bartels 
```

### Comparing credit unions that did and did not comment on Dodd-Frank rules


```{r creditunion-density, fig.height= 1.5, fig.width=4, out.width="50%"}
#creditunion-density

#load the full population of campaign donors 
creditunions <- read_csv(here("Data" , "creditunions.csv") %>% str_remove("finreg/") )

creditunions %<>% 
  group_by(CU_NAME) %>% 
  top_n(1, `Total Assets`) %>% 
  ungroup()

creditunions %<>% mutate(org_name = tolower(CU_NAME),
                         assets = `Total Assets`,
                         commented = org_name %in% d$best_match_name,
                         Commented = ifelse(commented, "Commented", "Did not comment"))

creditunions %>% count(Commented) %>% mutate(percent = n/nrow(creditunions))

creditunion_t <- t.test(creditunions %>% filter(!commented) %>% pull(assets),
       creditunions %>% filter(commented) %>% pull(assets))
creditunion_t

# density plots 
creditunions %>% 
  filter(assets > 10) %>% 
  ggplot() + 
  aes(x = assets/1000000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(fill = "", x = "Assets (Millions)", 
       title = str_c("Credit Unions, N = ", nrow(creditunions)%>% prettyNum(big.mark = ",")),
       fill = "", y = "",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", creditunion_t$p.value %>% round(3)))  + 
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

```


```{r creditunion-count, fig.height= 3, fig.width=4, out.width="50%"}
# creditunion-count 
creditunions %<>% 
  group_by(Commented) %>% 
  mutate(mean_assets = mean(assets, na.rm = T),
         median_assets = median(assets, na.rm = T) ) %>% 
  ungroup()

creditunions %>% distinct(Commented, mean_assets) %>% kable


# count histograms 
creditunions %>% 
    filter(assets > 100000) %>% 
  mutate(Commented = Commented %>% paste0(
    "\n(median = $", round(median_assets/1000000, 0), " million, ",
    "mean = $", round(mean_assets/1000000, 0), " million)"
    )) %>% 
  ggplot() + 
  aes(x = assets/1000000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_assets/1000000)) + 
    geom_vline( aes(xintercept = median_assets/1000000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = str_c("Credit Unions, N = ", nrow(creditunions)%>% prettyNum(big.mark = ",")),
       fill = "", y = "", x = "Assets (Millions)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", creditunion_t$p.value %>% round(3)))  + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```



---

## By Lobbying Spending

(OpenSecrets data)

```{r opensecrets-density, fig.height=1.5, fig.width=4, out.width="50%"}
#opensecrets-density

#load the full population of campaign donors 
opensecrets <- read_csv(here("data" , "merged_resources", 
"opensecrets_resources_JwVersion.csv") )




# indicator for whether they commented
opensecrets %<>% 
  mutate(org_name = orgName %>% str_to_lower(),
         Commented = ifelse(
    org_name %in% d$best_match_name,
    "Commented", 
    "Did not comment"))

# unique
opensecrets %<>% group_by(org_name) %>% 
  top_n(1, MeanContribAmount)

opensecrets %>% 
  group_by(Commented) %>% 
  summarise(mean_MeanContribAmount = mean(MeanContribAmount, na.rm = T),
            mean_MeanContribAmountPerYearContributed = mean(MeanContribAmountPerYearContributed, na.rm = T),
            MeanTotalContribAmount = mean(TotalContribAmount, na.rm = T)) %>% 
  kable()

opensecrets %>% 
  #filter(assets > 10) %>% 
  ggplot() + 
  aes(x = MeanContribAmount/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(fill = "",  
       y = "",
       title = str_c("Campaign Donors, N = ", nrow(opensecrets)%>% prettyNum(big.mark = ",")),
       x = "Mean Contribution
       ($1,000s, in years contributing 2010-2017)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

opensecrets %>% 
  #filter(assets > 10) %>% 
  ggplot() + 
  aes(x = MeanContribAmountPerYearContributed/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = str_c("Campaign Donors, N = ", nrow(opensecrets)%>% prettyNum(big.mark = ",")),
       fill = "", 
       y = "",
       x = "Mean Contribution per Year\n($1,000s, 2010-2017)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

opensecrets %>% 
  #filter(assets > 10) %>% 
  ggplot() + 
  aes(x = TotalContribAmount/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = str_c("Campaign Donors, N = ", nrow(opensecrets)%>% prettyNum(big.mark = ",")),
       y = "",
       x = "Total Contributions\n($1,000s, 2010-2017)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
```


```{r opensecrets-count, fig.height= 3, fig.width=4, out.width="50%"}
# opensecrets-count 
opensecrets %<>% 
  group_by(Commented) %>% 
  mutate(mean_MeanContribAmount = mean(MeanContribAmount, na.rm = T),
         median_MeanContribAmount = median(MeanContribAmount, na.rm = T) ) %>% 
  ungroup()

opensecrets %>% distinct(Commented, mean_MeanContribAmount) %>% kable

opensecrets %>% count(Commented) %>% mutate(percent = n/nrow(opensecrets))

opensecrets %<>% mutate(commented = Commented == "Commented")

opensecrets_t <- t.test(opensecrets %>% 
         filter(commented) %>% pull(MeanContribAmount),
       opensecrets %>% 
         filter(!commented) %>% pull(MeanContribAmount)
       )

opensecrets_t

# count histograms
opensecrets %>% 
    filter(MeanContribAmount > 100) %>% 
  mutate(Commented = Commented %>% paste0(
    "\n(median = $", round(median_MeanContribAmount/1000, 2), " million, ",
    "mean = $", round(mean_MeanContribAmount/1000, 1), " million)"
    )) %>% 
  ggplot() + 
  aes(x = MeanContribAmount/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_MeanContribAmount/1000)) + 
    geom_vline( aes(xintercept = median_MeanContribAmount/1000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = str_c("Campaign Donors, N = ", nrow(opensecrets)%>% prettyNum(big.mark = ",")),
       fill = "", y = "", x = "Political Action Committee Donations (Thousands)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", opensecrets_t$p.value %>% round(3))
       ) + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

---

## By Market Cap

(Computstat data)

```{r compustat-density, fig.height=1.5, fig.width=4, out.width="50%"}
compustat <- read_csv(here("data/merged_resources/compustat_resources.csv"))

#TODO CIK NOW HAS MATCHES, SHOULD BE COMBINED HERE 

compustat %<>% 
  mutate(org_name = conm %>% str_to_lower(),
         Commented = ifelse(
    org_name %in% d$best_match_name,
    "Commented", 
    "Did not comment"),
    commented = Commented == "Commented") %>% 
  mutate(marketcap2 = ifelse(str_detect(marketcap, "k"),
                             marketcap %>% str_remove("k") %>% as.numeric() * 1000,
                             marketcap),
         marketcap2 = ifelse(str_detect(marketcap, "M"),
                             marketcap %>% str_remove("M") %>% as.numeric() * 1000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "B"),
                             marketcap %>% str_remove("B") %>% as.numeric() * 1000000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "T"),
                             marketcap %>% str_remove("T") %>% as.numeric() * 1000000000000,
                             marketcap2),
         marketcap2 = marketcap2 %>% str_remove(",") %>%  as.numeric(marketcap2))

#compustat %>% filter(is.na(marketcap2), !is.na(marketcap)) %>% pull(marketcap)

# unique
compustat %<>% group_by(org_name) %>% 
  top_n(1, marketcap2) %>% 
  ungroup() 


compustat %>% count(Commented) %>% mutate(percent = n/nrow(compustat))

compustat_t <- t.test(compustat %>% filter(commented) %>% pull(marketcap2),
       compustat %>% filter(!commented) %>% pull(marketcap2))

compustat_t

compustat %>% 
  group_by(Commented) %>%
  filter(marketcap2 > 1000) %>% 
  ggplot() + 
  aes(x = marketcap2/1000000, fill = Commented) + 
  labs(fill = "", 
       y = "",
       title = str_c("Publically-traded Companies, N = ", nrow(compustat)%>% prettyNum(big.mark = ",")),
       x = "Market Capitalization (Millions)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", compustat_t$p.value %>% round(3))
       ) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  #geom_vline(aes(xintercept = mean)) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
```

```{r compustat-count, fig.height= 3, fig.width=4, out.width="50%"}
# compustat-count 
compustat %<>% 
  group_by(Commented) %>% 
  mutate(mean_marketcap2 = mean(marketcap2, na.rm = T),
         median_marketcap2 = median(marketcap2, na.rm = T) ) %>% 
  ungroup()

compustat %>% distinct(Commented, mean_marketcap2) %>% kable


# count histograms
compustat %>% 
    filter(marketcap2 > 1000) %>% 
  mutate(Commented = Commented %>% paste0(
    "\n(median = $", round(median_marketcap2/1000000000, 1), " billion, ",
    "mean = $", round(mean_marketcap2/1000000000, 1), " billion)"
    )) %>% 
  ggplot() + 
  aes(x = marketcap2/1000000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_marketcap2/1000000)) + 
    geom_vline( aes(xintercept = median_marketcap2/1000000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = str_c("Publically-traded Companies, N = ", nrow(compustat)%>% prettyNum(big.mark = ",")),
       fill = "", y = "", x = "Market Cap (Millions)",
       caption = str_c("Welch two-sample t-test of difference in means, p-vaue = ", compustat_t$p.value %>% round(3))
       ) + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

## Temporarily merging in data where matches are NA

```{r merge}
#FIXME 
# TO GET NON-COMMENTERS, WE NEED TO JOIN IN THE OTHERS, BUT WE MIGHT NOT NEED THIS?
# Until the asset data are fixed to include matches in multiple datasets. 
d %<>% left_join(opensecrets %>% dplyr::select(org_name, MeanContribAmount, TotalContribAmount)  ) %>%
  left_join(nonprofit_resources %>% dplyr::select(org_name, assets, revenue) ) %>%
  left_join(compustat %>% dplyr::select(-index) %>% dplyr::select(org_name, marketcap, naics) ) %>% 
  left_join(creditunions %>% dplyr::select(org_name, `Total Assets`))

d %<>% distinct()

##### 
# Instead, just keeping d limited to commenters and using matched data vars 

# requires renaming to align with above (and analysis code below)

# COMBINE matched and unmatched opensecrets 
d %<>% mutate(
  MeanContribAmount = coalesce(
    `opensecrets_resources_jwVersion-bestMatch:MeanContribAmountPerYearContributed`, # matched 
    MeanContribAmount # from opensecrets 
    ),
  TotalContribAmount = coalesce(
    `opensecrets_resources_jwVersion-bestMatch:TotalContribAmount`, # matched 
    TotalContribAmount     # from open secrets 

    )
)


# combine matched and unmatched nonprofits 
d %<>% mutate(
  assets = coalesce(`nonprofits_resources-bestMatch:assets`, #matched
                    assets, # from nonprofits
                    `Total Assets` # from credit unions 
                    ),
  revenue = coalesce(`nonprofits_resources-bestMatch:revenue`, #matched 
                     # from nonprofits
                     revenue)
)

# combine matched and unmatched marketcap
d  %<>% 
  mutate(marketcap = coalesce(
    `CIK-bestMatch:marketcap`, 
    `compustat_resources-bestMatch:marketcap`,
    marketcap),
         marketcap2 = ifelse(str_detect(marketcap, "k"),
                             marketcap %>% str_remove("k") %>% as.numeric() * 1000,
                             marketcap),
         marketcap2 = ifelse(str_detect(marketcap, "M"),
                             marketcap %>% str_remove("M") %>% as.numeric() * 1000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "B"),
                             marketcap %>% str_remove("B") %>% as.numeric() * 1000000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "T"),
                             marketcap %>% str_remove("T") %>% as.numeric() * 1000000000000,
                             marketcap2),
         marketcap2 = marketcap2 %>% str_remove(",") %>%  as.numeric(marketcap2))


```


We have market cap for  `r d %>% filter(!is.na(marketcap)) %>% count(best_match_name)  %>% nrow()` companies that submitted `r nrow(d %>% filter(!is.na(marketcap)))` comments.
```{r marketcap-inspect}
# fishy
d %>% 
  ggplot() +
  aes(x = marketcap2) + 
  geom_histogram()

d %>% arrange(-marketcap2) %>% count(marketcap, marketcap2, best_match_name, sort = T) %>% filter(!is.na(marketcap))

# unique(d$marketcap)
```



---

## Duplicates

(more than one match per comment URL)

Orgs in multiple states were one problem. For example, the API incorporated in DC has \$128,273,933 in assets while API in TX has \$15,368. Yale University had \$27,801,734,697 in assets (must include the endowment), and another Yale University had $4,858,646, both in CT.

```{r duplicates}

d %<>% distinct()
# duplicates
d %>% 
  add_count(comment_url, name = "n_per_url", sort = T) %>% 
  ungroup() %>% 
  filter(n_per_url > 1) %>% distinct() %>% 
  arrange(comment_url) %>%
  kablebox()
```

We solved this by selecting the entry with the highest assets. For example, the API now only matches the API's DC location. 

However, in the prior version of the data, the American Petroleum Institute and Yale University were both matched to nonprofit asset data and to opensecrets. Now, Yale Law has opensecrets data but no asset data, while API has asset data but no campaign donations. Yale University has neither -- it is matched in CIK data, but its marketcap is NA, so we now have nothing for it. 

```{r}
d %<>% distinct()

d %>% filter(str_detect(best_match_name, "petroleum inst|yale uni")) %>% # view
  dplyr::select(comment_url, best_match_name, 
         assets, 
         `nonprofits_resources-bestMatch:assets`, 
         `nonprofits_resources-bestMatch:revenue`,
         `nonprofits_resources-bestMatch:ein`,
         opensecrets_resources_name,
         MeanContribAmount,
         CIK_name,
         `CIK-bestMatch:marketcap`) %>% 
  kablebox()
```

<!--
But we still have almost as many duplicates when we drop `state`, partially because assets vary for the same "org" registered in different states: 

```{r duplicates2, eval = FALSE }
# duplicates after removing state
d %>% 
  dplyr::select(-state) %>%
  add_count(comment_url, name = "n_per_url") %>% 
  ungroup() %>% 
  filter(n_per_url > 1) %>% distinct() %>% 
  arrange(comment_url) %>%
  kablebox()
```

--> 

## Asset data coverage by docket

```{r}
is_not_na <- . %>% is.na() %>% isFALSE()


dtable <- d_rin_lookup %>%
  ungroup() %>% 
  full_join(d %>% dplyr::select(docket_id, comment_url, ends_with("_name"))) %>%
  ungroup() %>% 
  # add_count(docket_id) %>% 
  group_by(comment_url) %>% 
  mutate(across(ends_with("name"), is_not_na)) %>% 
  mutate(asset_data_name = sum( CIK_name, CreditUnions_name, FDIC_Institutions_name,	FFIECInstitutions_name,	SEC_Institutions_name,	compustat_resources_name,	nonprofits_resources_name) > 0#,
         #unique_orgs_name = org_name %>% unique() %>% length() 
         ) %>% 
  dplyr::select(docket_id, comment_count, comments_matched, lowest.sorted.rin.of.related.rins,related.rins,
         comment_url, ends_with("_name")) %>% 
  distinct() %>% 
  group_by(docket_id, comment_count, comments_matched, lowest.sorted.rin.of.related.rins,related.rins) %>% 
  # tally up matches
  summarise(across(ends_with("name"), sum)) %>% 
  # select vars for table 
  dplyr::select(docket_id,  lowest.sorted.rin.of.related.rins,related.rins, comment_count, comments_matched, asset_data_name,
         #unique_orgs_name,
        nonprofits_resources_name,
         CIK_name, CreditUnions_name, FDIC_Institutions_name,	FFIECInstitutions_name,	SEC_Institutions_name,	compustat_resources_name) %>% 
  ungroup() %>%
  distinct() %>% 
  arrange(-asset_data_name) 



sum2 <- . %>% sum(na.rm = TRUE)

dtable %>% summarise(across(where(is.numeric), sum2)) %>% pivot_longer(everything(), names_to = "measure") %>% kable()
  
dtable %>% write_csv(here::here("data", "matches_per_rin.csv"))
```


## Save asset data
```{r save}
#FIXME ideally all edits to these data would be in clean_match_data
commenter_assets <- d

n_orgs <- d$org_name %>% unique() %>% length()

# + non-commenters 
n_orgs_total <- c(FDIC_resources$org_name,
  nonprofit_resources$org_name,
  opensecrets$org_name,
  compustat$org_name) %>% 
  unique() %>% 
  length()

n_assets <- nrow(d)

save(commenter_assets, 
     n_orgs, n_orgs_total, 
     n_assets,
     n_rules,
     n_actions,
     file = here::here("data", "commenter_assets.Rdata"))
```

---

# Frequency of participation among organizations that commented

Among commenting organizatyions, how many rules did each comment on?

```{r asset-counts, fig.width=4, fig.height= 2, out.width= "50%"}
asset_counts <- d %>% 
  mutate(assets = org_resources) %>% 
  filter(assets > 10) %>%
  distinct(org_name, docket_id, assets) %>% 
  count(org_name, assets) %>% 
  filter(!is.na(assets)) %>% 
  mutate(nnp = quantile(n, probs = .99),
         assets_m = assets /1000000,
         assets_b = assets_m / 1000,
         onepercent = ifelse(n > nnp, "Top 1%", "Bottom 99%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n > nnp)

rules_t <- t.test(asset_counts %>% filter(top) %>% pull(assets),
                  asset_counts %>% filter(!top) %>% pull(assets),)

rules_t

asset_counts %>% 
  ggplot() + 
  aes(x = n,  fill = onepercent) + 
  geom_bar() + 
  labs(title = "Banks and Nonprofits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       y = "Number of Organizations",
       fill = "Frequency of\nCommenting",
       x = "Dodd-Frank Rules per Organization") #+ scale_y_log10()


asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Banks and Nonprofits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", 
       x = "Assets (Millions)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

  

asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Banks and Nonprofits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", 
       x = "Assets (Millions)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())




m_asset_count <- lm(n ~ assets_b, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Rules",
)

attr(rows, 'position') <- c(0)

modelsummary(m_asset_count)
```


For every additional 10 billion in assets, an organization comments on about `r round(m_asset_count$coefficients[2]* 10,0) ` additional rules. 

---

## Among nonprofits that commented on a Dodd-Frank rule

```{r nonprofit-rules, fig.width=4, fig.height= 2, out.width= "50%"}
asset_counts <- d %>% 
  mutate(assets = `nonprofits_resources-bestMatch:assets`) %>% 
  filter(assets > 10) %>%
  distinct(org_name, docket_id, assets) %>% 
  count(org_name, assets) %>% 
  filter(!is.na(assets)) %>% 
  mutate(nnp = quantile(n, probs = .99),
         assets_t = assets / 1000,
         assets_m = assets_t /1000,
         assets_b = assets_m / 1000,
         onepercent = ifelse(n > nnp, "Top 1%", "Bottom 99%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n > nnp)

asset_counts %>% filter(onepercent == "Top 1%") %>% distinct(n) %>% min()

rules_nonprofits_t <- t.test(asset_counts %>% filter(top) %>% pull(assets),
                  asset_counts %>% filter(!top) %>% pull(assets),)

rules_nonprofits_t 

asset_counts %>% 
  ggplot() + 
  aes(x = n, fill = onepercent) + 
  geom_bar() + 
  labs(title = "Nonprofits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       y = "Number of Nonprofits",
       fill = "Frequency of\nCommenting",
       x = "Number of Dodd-Frank Rules") # + scale_y_log10()

asset_counts %>% 
  ggplot() + 
  aes(x = assets_t, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Nonprofits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
        fill = "Frequency of\nCommenting", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch two-sample t-test, p-value = ", rules_nonprofits_t$p.value %>% round(3)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
  

asset_counts %>% 
  ggplot() + 
  aes(x = assets_t, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Nonprofits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
        fill = "Frequency of\nCommenting", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch two-sample t-test, p-value = ", rules_nonprofits_t$p.value %>% round(3)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


m_nonprofit_count <- lm(n ~ assets_b, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Dodd-Frank Rules",
)

attr(rows, 'position') <- c(0)

modelsummary(m_nonprofit_count)
```


For every additional 10 billion in assets, a nonprofit comments on about `r round(m_nonprofit_count$coefficients[2]* 10,1) ` additional rules. 

---

## Among FDIC-insured that commented on a Dodd-Frank rule

```{r fdic-rules, fig.width=4,  fig.height= 2,out.width= "50%"}
asset_counts <- d %>% 
  mutate(assets = `FDIC_Institutions-bestMatch:ASSET`) %>% 
  filter(assets > 10) %>%
  distinct(org_name, docket_id, assets) %>% 
  count(org_name, assets) %>% 
  filter(!is.na(assets)) %>% 
  mutate(nnp = quantile(n, probs = .99),
         assets_t = assets /1000,
         assets_m = assets_t /1000,
         assets_b = assets_m / 1000,
         onepercent = ifelse(n > nnp, "Top 1%", "Bottom 99%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n>nnp)

rules_fdic_t <- t.test(asset_counts %>% filter(top) %>% pull(assets),
                  asset_counts %>% filter(!top) %>% pull(assets),)

rules_fdic_t 

asset_counts %>% 
  ggplot() + 
  aes(x = n, fill = onepercent) + 
  geom_bar() + 
  labs(y = "Number of Banks",
       title = "FDIC-Insured Banks" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       x = "Number of Dodd-Frank Rules") #+ scale_y_log10()
  
asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "FDIC-Insured Banks" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", x = "Assets (Millions)",
       caption = str_c("Welch two-sample t-test, p-value = ", rules_fdic_t$p.value %>% round(3)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "FDIC-Insured Banks" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", x = "Assets (Millions)",
       caption = str_c("Welch two-sample t-test, p-value = ", rules_fdic_t$p.value %>% round(3)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


m_fdic_count <- lm(n ~ assets_b, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Dodd-Frank Rules"
  )

attr(rows, 'position') <- c(0)

modelsummary(list(m_fdic_count))
```


For every additional 10 billion in assets, a nonprofit comments on about `r round(m_fdic_count$coefficients[2]* 10,0) ` additional rules. 


---



## Among credit unions that commented on a Dodd-Frank rule

```{r creditunion-rules, fig.width=4,  fig.height= 2,out.width= "50%"}
asset_counts <- d %>% 
  mutate(assets = `Total Assets`) %>% # credit union call reports Total Assets
  filter(assets > 10, !is.na(assets)) %>%
  distinct(org_name, docket_id, assets) %>% 
  count(org_name, assets) %>% 
  mutate(nnp = quantile(n, probs = .9),
         assets_t = assets /1000,
         assets_m = assets_t /1000,
         assets_b = assets_m / 1000,
         onepercent = ifelse(n > nnp, "Top 1%", "Bottom 99%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n>nnp)

rules_creditunion_t <- t.test(asset_counts %>% filter(top) %>% pull(assets),
                  asset_counts %>% filter(!top) %>% pull(assets),)

rules_creditunion_t

asset_counts %>% 
  ggplot() + 
  aes(x = n, fill = onepercent) + 
  geom_bar() + 
  labs(y = "Number of Credit Unions",
       title = "Credit Unions" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       x = "Number of Dodd-Frank Rules") #+ scale_y_log10()
  
asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Credit Unions" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", x = "Assets (Millions)",
       caption = str_c("Welch two-sample t-test, p-value = ", rules_creditunion_t$p.value %>% round(3)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Credit Unions" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", x = "Assets (Millions)",
       caption = str_c("Welch two-sample t-test, p-value = ", rules_creditunion_t$p.value %>% round(3)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


m_creditunion_count <- lm(n ~ assets_b, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Dodd-Frank Rules"
  )

attr(rows, 'position') <- c(0)

modelsummary(list(m_creditunion_count))
```


For every additional billion in assets, a credit union comments on about `r round(m_creditunion_count$coefficients[2]* 10,0) ` additional rules. 


---


## Among publically-traded companies that commented on a Dodd-Frank rule

```{r compustat-rules, fig.width=4, fig.height= 2, out.width= "50%"}
# compustat-rules


# combine and count 
asset_counts <- d %>% 
  mutate(marketcap = marketcap2) %>% 
  filter(marketcap > 10) %>%
  distinct(org_name, docket_id, marketcap) %>% 
  count(org_name, marketcap) %>% 
  filter(!is.na(marketcap)) %>% 
  mutate(nnp = quantile(n, probs = .9),
         marketcap_t = marketcap /1000,
         marketcap_m = marketcap_t /1000,
         marketcap_b = marketcap_m / 1000,
         onepercent = ifelse(n > nnp, "Top 10%", "Bottom 90%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n > nnp)


rules_compustat_t <- t.test(asset_counts %>% filter(top) %>% pull(marketcap),
                  asset_counts %>% filter(!top) %>% pull(marketcap),)

rules_compustat_t 

asset_counts %>% 
  ggplot() + 
  aes(x = n, fill = onepercent) + 
  geom_bar() + 
  labs(y = "Number of Companies",
       title = "Publicaly-Traded Companies" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       x = "Number of Dodd-Frank Rules") #+ scale_y_log10()
  
asset_counts %>% 
  ggplot() + 
  aes(x = marketcap_b, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Publicaly-Traded Companies" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting", y = "", x = "Market Cap (Billions)",
       caption = str_c("Welch two-sample t-test, p-value = ", rules_compustat_t$p.value %>% round(3)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


asset_counts %>% 
  ggplot() + 
  aes(x = marketcap_b, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Publicaly-Traded Companies" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting", y = "", x = "Market Cap (Billions)",
       caption = str_c("Welch two-sample t-test, p-value = ", rules_compustat_t$p.value %>% round(3)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


m_compustat_count <- lm(n ~ marketcap_b, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Dodd-Frank Rules"
  )

attr(rows, 'position') <- c(0)

modelsummary(list(m_compustat_count))
```


For every additional 10 billion in assets, a nonprofit comments on about `r round(m_compustat_count$coefficients[2]* 10,0) ` additional rules. 

---

## Among campaign donors that commented on a Dodd-Frank rule

```{r opensecrets-rules, fig.width=4, fig.height= 2, out.width= "50%"}
asset_counts <- d %>% 
  mutate(donations = `opensecrets_resources_jwVersion-bestMatch:MeanContribAmountPerYearContributed`) %>% 
  filter(donations > 10) %>%
  distinct(org_name, docket_id, donations) %>% 
  count(org_name, donations) %>% 
  filter(!is.na(donations)) %>% 
  mutate(nnp = quantile(n, probs = .9),
         donations_m = donations / 1000000,
         onepercent = ifelse(n > nnp, "Top 10%", "Bottom 90%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n>nnp)

rules_pac_t <- t.test(asset_counts %>% filter(top) %>% pull(donations),
                  asset_counts %>% filter(!top) %>% pull(donations),)

rules_pac_t 


asset_counts %>% 
  ggplot() + 
  aes(x = n, fill = onepercent) + 
  geom_bar() + 
  labs(title = "Campaign Donors" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       y = "Number of Organizations",
        fill = "Frequency of\nCommenting",
       x = "Number of Dodd-Frank Rules") #+ scale_y_log10()
  

asset_counts %>% 
  ggplot() + 
  aes(x = donations_m, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Campaign Donors" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
        fill = "Frequency of\nCommenting", 
       y = "", x = "PAC Donations (Thousands)",
       caption = str_c("Welch two-sample t-test, p-value = ", rules_pac_t$p.value %>% round(3)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


asset_counts %>% 
  ggplot() + 
  aes(x = donations_m, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Campaign Donors" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
        fill = "Frequency of\nCommenting", 
       y = "", x = "PAC Donations (Thousands)",
       caption = str_c("Welch two-sample t-test, p-value = ", rules_pac_t$p.value %>% round(3)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


m_opensecrets_count <- lm(n ~ donations_m, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Dodd-Frank Rules",
)

attr(rows, 'position') <- c(0)

modelsummary(m_opensecrets_count)
```


For every additional 10 million in Political Action Committee campaing donations, an organization comments on about `r round(m_opensecrets_count$coefficients[2]* 10,0) ` additional rules. 

---

## All

```{r all-rules}

models <- list(#`All` = m_asset_count, 
               `Non-profits` = m_nonprofit_count,
               `Credit Unions`= m_creditunion_count,
               `Public Companies` = m_compustat_count,
               `Banks` = m_fdic_count,
               `PAC Donors` = m_opensecrets_count)

rows <- tibble(
  term = c("Dependent Variable"),
  #`All` = "Number of Rules",
      `Nonprofits` = "Number of Rules",
  `Credit Unions`= "Number of Rules",
  `Public Companies` = "Number of Rules",
  `Banks` = "Number of Rules",
    `PAC Donors` = "Number of Rules",
  )

attr(rows, 'position') <- c(0)


modelsummary(models)

save(models, rows, cm, gof_map, modelsummary,
     file = here::here("models", "rules-by-assets.Rdata"))
```

---

## Comments per rule

### Percent of comments by each organization type on any one rule
```{r}
# comments 
# of the matched sample 
# 90% of credit union comments, half of nonprofits, and 75% campaig
d %>% 
  mutate(docket_id = str_split(docket_id, ";")) %>% 
  unnest(docket_id) %>% 
    add_count(org_type, name = "dataset_total") %>% 
  count(org_type, docket_id, dataset_total, sort = T) %>%
  mutate(percent = percent( n / dataset_total , accuracy = 1)) %>% 
  kablebox()
```


### Percent of each organization type on any one rule

```{r}
# orgs (15% of nonprifits on payday loan rule, 30% of opensecrets)
d %>% 
 mutate(docket_id = str_split(docket_id, ";")) %>% 
  unnest(docket_id) %>% 
  # org rather than comment level counts now
  distinct(org_name, docket_id, org_type) %>% 
  # total orgs of each type  in dataset 
  add_count(org_type, name = "dataset_total") %>% 
  # number of each org type by docket 
  count(org_type, docket_id, `dataset_total`, sort = T) %>%
  mutate(percent = percent( n / dataset_total , accuracy = 1)) %>% 
  kablebox()
```

### Most Frequently Commenting Orgs
```{r}
# 
d %>% 
  # filter(comment_agency == "CFPB") %>% 
  # mutate(docket_id = comment_url %>% str_extract("CFPB-[0-9]*-[0-9]*")) %>% 
  count(org_name, best_match_name, org_type, docket_id, sort = T) %>% kablebox()
```


# Probability of Commenting

These models have the prefix `mp_`. The dependent variable is the probability that the organization comments.

### FDIC-insured Banks

SM = Comptroller of the Currency (OCC). National Charter and a Fed member.

NM = Commercial Bank. The bank is supervised by the Federal Deposit Insurance Corporation (FDIC). State charter and Fed non-member

SB = Savings Bank. The bank is supervised by the Federal Deposit Insurance Corporation (FDIC). State Charter.

OI = Bank is an insured United States branch of a foreign chartered institution (IBA)

N = National Associations (Ommitted)

Assets in hundreds of millions

```{r cache=FALSE}
# FDIC_resources %>% filter(BKCLASS == "NM")

FDIC_resources %<>% mutate(Class = str_c(" ", BKCLASS) %>% as.factor() %>% relevel(ref = " SA"),
                           ASSETS = ASSET/100000000,
                           Assets = ASSET/1000000000) 
# %>% 
#   mutate(BKCLASS = BKCLASS %>% str_replace("^NM", "SBNM"))  %>% 
#   mutate(BKCLASS = BKCLASS %>% str_replace("^NM", "SBNM"))

unique(FDIC_resources$BKCLASS)

```


```{r mpFDIC, cache=FALSE, fig.height=2, fig.width=6}
#mpFDIC
mpFDICbillions <- glm(commented ~ Assets,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC <- glm(commented ~ ASSETS,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC_BKCLASSonly <- glm(commented ~ Class,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC_BKCLASS <- glm(commented ~ ASSETS + Class,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDICxBKCLASS <- glm(commented ~ ASSETS*Class,
           data = FDIC_resources, 
             family=binomial(link="logit"))


rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Comment",
  `2` = "Comment",  
  #`3` = "Comment"
)

attr(rows, 'position') <- c(0)

models <- list(mpFDIC,# mpFDIC_BKCLASSonly,
               mpFDIC_BKCLASS#,
               #mpFDICxBKCLASS
               )

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

modelplot(models[1:2], coef_map = cm) +
  labs(title  = "FDIC-Insured Banks",
x = "Change in Log Odds of Commenting",
caption = "Reference Category = Savings Associations") +
  theme(panel.grid.major.x =  element_blank(),
        panel.grid.major.y =  element_blank()) + 
  scale_color_viridis_d(end = .6)


save(models, rows, cm, gof_map, modelsummary,
     file = here::here("models", "mpFDIC.Rdata"))
```


### Nonprofits

Assets in billions

```{r mp-nonprofits}
nonprofit_resources %<>% mutate(Assets = assets/1000000000)

mpNonprofit <- glm(commented ~ Assets,
           data = nonprofit_resources , 
             family=binomial(link="logit"))

mpNonprofit_revenue <- glm(commented ~ Assets + revenue,
           data = nonprofit_resources, 
             family=binomial(link="logit"))

models <- list(mpNonprofit, mpNonprofit_revenue)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Comment",
  `2` = "Comment",  
)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

modelplot(models)+ 
  theme(panel.grid.major.x =  element_blank()) + 
  labs(x = "Change in Log Odds of Commenting")
```

### Credit Unions

Assets in billions

 
```{r mp-credit-unions}
creditunions %<>% mutate(Assets = assets/100000000)


mp_creditunions <- glm(commented ~ Assets,
           data = creditunions, 
             family=binomial(link="logit"))

models <- list(mp_creditunions)


rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Commented",
)

attr(rows, 'position') <- c(0)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

modelplot(models)+ 
  theme(panel.grid.major.x =  element_blank()) + 
  labs(x = "Change in Log Odds of Commenting per Billion in Assets")
```

### Banks, Nonprofits, Credit Unions Compared

```{r mp-nonprofit-credit-unions}
# nonprofit-credit-unions
models <- list(mpFDICbillions, mpNonprofit, mp_creditunions)

names(models) <- c("FDIC-Insured Banks", "Nonprofits", "Credit Unions")


modelplot(models, coef_map = cm) + 
  theme(panel.grid.major.x =  element_blank()) + 
  labs(x = "Change in Log Odds of Commenting per Billion in Assets") +
  facet_wrap("model", scales = "free", ncol = 1)


rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Commented",
  `2` = "Commented",
  `3` = "Commented"
)

attr(rows, 'position') <- c(0)

modelsummary(models)

save(models, rows, cm, gof_map, modelsummary, 
     file = here::here("models", "pr-of-comment.Rdata"))
```

### Campaign Donors

```{r mp-opensecrets}
opensecrets %<>% mutate(commented = Commented == "Commented")

mpOpensecrets <- glm(commented ~ MeanContribAmount,
           data = opensecrets, 
             family=binomial(link="logit"))

mpOpensecrets_total <- glm(commented ~ TotalContribAmount,
           data = opensecrets, 
             family=binomial(link="logit"))

models <- list(mpOpensecrets, mpOpensecrets_total)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Commented",
  `2` = "Commented"
)

attr(rows, 'position') <- c(0)


equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

# modelplot(models)
```

### By Market Cap
```{r mp-compustat}
compustat %<>% mutate(commented = Commented == "Commented",
                      marketcap_b = marketcap2/1000000000)


mpCompustat <- glm(commented ~ marketcap_b,
           data = compustat, 
             family=binomial(link="logit"))

top_naics <- compustat %>% count(naics, sort = T) %>% 
  drop_na(naics) %>% 
  top_n(10, wt = n) %>% 
  pull(naics)

mpCompustat_naics <- glm(commented ~ NAICS_,
           data = compustat %>% mutate(NAICS_ = ifelse(naics %in% top_naics, naics, "other")), 
             family=binomial(link="logit"))

models <- list(mpCompustat, mpCompustat_naics)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

#modelplot(models)

 modelplot(mpCompustat)
 
# modelplot(mpCompustat_naics)
```

## Together

```{r mp-all}
all <- full_join(
  FDIC_resources %>% dplyr::select(assets = ASSET, commented, org_type = Class) %>% mutate(org_type = "Bank"),
  nonprofit_resources %>% dplyr::select(assets, commented) %>% mutate(org_type = "Non-profit")
) %>% 
  full_join(
  creditunions %>% dplyr::select(assets, commented) %>% mutate(org_type = "Credit union")
  )

all %<>% mutate(assets_b = assets  / 100000000) # %>% filter(org_type != " SB", org_type != " SM")

mpAll <- glm(commented ~ assets_b + org_type,
           data = all, 
             family=binomial(link="logit"))

mpAlli <- glm(commented ~ assets_b * org_type,
           data = all, 
             family=binomial(link="logit"))


models <- list(mpAll, mpAlli)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Commented",
  `2` = "Commented"
)

attr(rows, 'position') <- c(0)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

# modelplot(models)

save(models, rows, cm, gof_map, modelsummary,
     file = here::here("models", "mpAll.Rdata"))
```



# TODO 

Priorities for matching that will give us the most leverage

- [ ] Best match in *each* dataset rather than best match in *one* dataset: https://finreggroup.slack.com/archives/C027MRLQFLJ/p1650733175102459

- [ ] Comments on dockets with 0 comments matched: https://judgelord.github.io/finreg/participation#Asset_data

- [ ] Underpowered subsets, especially marketcap (hopefully matching both compustat and CIK will help with this): https://judgelord.github.io/finreg/participation#By_Market_Cap

- [ ] FDIC `BKCLASS` == "national associations" that we are currently dropping: https://judgelord.github.io/finreg/participation#FDIC_instituttions  https://finreggroup.slack.com/archives/C027MRLQFLJ/p1653322086231879

- [ ] False positives that I am currently dropping https://finreggroup.slack.com/archives/C027MRLQFLJ/p1650658969445029

Analyses to clean up and add to the paper 

- [ ] Lobbying expendatures from CRP (replication all PAC figures and models)

- [ ] Nonprofit revenue (maybe just add the revenue figures and models to the appendix)

- [ ] the full (best-ish) model includes nonprofits, credit unions, and each type of bank as seperate org_types. This model is run above but needs to be investited 

Presentation 

- [ ] Predicted probability plots for all models presented in the paper. These should replace all tables. All tables should appear in the appendix. 

- [ ] Nonprofit and credit union plots for the correlation between assets and sophsitication

