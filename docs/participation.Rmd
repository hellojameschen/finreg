---
title: "Participation in Financial Rulemaking"
#subtitle: "Appendix and Replication Code" 
output:
    bookdown::html_document2:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
      number_sections: false
# output:
#   xaringan::moon_reader:
#     lib_dir: libs
#     mathjax: "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"
#     css: xaringan-themer.css
#     nature:
#       highlightStyle: github
#       highlightLines: true
#       countIncrementalSlides: false
---



```{r options, include=FALSE}
# rmarkdown::render("docs/participation.Rmd")

## Sets defaults for R chunks
knitr::opts_chunk$set(#echo = FALSE, # echo = TRUE means that code will show
                      cache = FALSE,
                      #cache = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.show="hold",
                      fig.pos= "htbp",
                      fig.path = "../figs/",
                      fig.align='center',
                      fig.cap = '   ',
                      fig.retina = 1, #6, #FIXME for publication quality images
                      fig.height = 3,
                      fig.width = 7,
                      out.width = "100%",
                      out.extra = "")

library("xaringan")
library("xaringanthemer")
library("here")
library("modelsummary")

library(scales)
library(magrittr)
library(broom)
#library(dotwhisker)
library(here)
library(knitr)
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)
#library(mediation)
#library(lme4)
#library(lmerTest)
#library(fixest)
#library(modelsummary)
library(tidyverse)

# table defaults
modelsummary <- function(...) modelsummary::modelsummary(..., 
                                                         stars = T, 
                                                         add_rows = rows,
                                                         coef_rename = cm,
                                                         coef_omit = "(Intercept)") %>% 
  row_spec(row = 1, bold = T)

# coeficient plot defaults
modelplot <- function(...) modelsummary::modelplot(..., coef_omit = "(Intercept)") + 
  geom_vline(xintercept = 0, linetype = 2, alpha = .5) + 
  aes(shape = model)

style_mono_light(base_color = "#3b444b",
          link_color = "#B7E4CF",
          #background_color = "#FAF0E6", # linen
          header_font_google = google_font("PT Sans"), 
          text_font_google = google_font("Old Standard"), 
          text_font_size = "18px",
          padding = "10px",
          code_font_google = google_font("Inconsolata"), 
          code_inline_background_color    = "#F5F5F5", 
          table_row_even_background_color = "#ddede5",
          extra_css = 
            list(".remark-slide-number" = list("display" = "none")))
```

```{r setup}
options(scipen=999)

# source(here::here("code", "setup.R"))

# defaults for plots
library(ggplot2); theme_set(theme_minimal());
options(
  ggplot2.continuous.color = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_color_discrete <- function(...){
  scale_color_viridis_d(..., direction = -1, 
                        begin = 0, end = .6, option = "plasma")}
scale_fill_discrete <- function(...){
  scale_fill_viridis_d(..., direction = -1, 
                       begin = 0, end = .6, option = "plasma")}

scale_color_continuous <- function(...){
  scale_color_viridis_c(..., direction = -1, 
                        option = "plasma")}
scale_fill_continuous <- function(...){
  scale_fill_viridis_c(..., direction = -1, 
                       option = "plasma")}

# Table formatting
library(kableExtra)
kablebox <- . %>% 
  slice_head(n = 300) %>%
  knitr::kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "400px")
```

# Data

The root for this script is `finreg`. Most of the data are in `finreg/data` (some in a subfolder `merged_resources`). Others are up one level in `FINREGRULEMAKE2/Data`. This can and should be streamlined significantly. 

Rules and comments: 

- Agency actions: `finreg/data/actions.csv`
- RIN-level data: `finreg/data/dodd-frank-rulemaking-directory_doc_oriented_wdescription.xls` and `finreg/data/docket_related_rin_lookup.csv`
- Docket-level comment data: `finreg/data/matches_per_docket.csv`


Resource data: 
- For commenters: `finreg/data/match_data_clean.Rdata`

Resource data for full population of organizations, including non-commmenters: 

- Nonprofit `assets` and `revenue` from 990 data from https://www.irs.gov/charities-non-profits/form-990-series-downloads: `finreg/data/nonprofit_resources.Rdata` or `finreg/data/merged_resources/nonprofit_resources.csv`
- FDIC assets (`ASSET`) and bank class (`BKCLASS`): `finreg/data/FDIC_resources.Rdata` or `finreg/data/merged_resources/FDIC_Institutions.csv`
- Credit unions `Total Assets` scraped from consolidated call report files scraped from https://www.ncua.gov/analysis/credit-union-corporate-call-report-data by `acquisition/get_credit-Unions.py`: `Data/creditunions.csv` (up one level, not in finreg)
- Campaign donations (`MeanContribAmount` and `MeanContribAmount`) from https://www.opensecrets.org/: `finreg/data/merged_resources/opensecrets_resources_JwVersion.csv`
- Market capitalization (`marketcap`) from compustat? `Data/compustat_names.csv` and SEC's CIK database `Data/CIK.csv`: `finreg/data/merged_resources/compustat_resources.csv`

Sophistication Measures 


Efficacy measures

- `Data/attachment_efficacy_w_docket.csv`

```{r action-data}
# actions 
actions <- read_csv(here("data" , "actions.csv"))

actions %>% distinct(docket_id) %>% nrow

library("readxl")

rins <- read_excel(here::here("data", "dodd-frank-rulemaking-directory_doc_oriented_wdescription.xls")) %>% 
  rename(docket_id = identifier)  %>% 
  select(-"...1")

lookup <- read_csv(here::here("data", "docket_related_rin_lookup.csv")) %>% 
  select(-"...1") %>% 
  mutate(across(everything(), str_squish))

rin_lookup <- full_join(rins, lookup, by = "docket_id", suffix = c(".directory", ".lookup")) %>% 
  mutate(title = str_to_title(title) %>% str_squish()) %>% 
  mutate(across(everything(), str_squish))
```

Some dockets don't have related rins in lookup table 
```{r rins-missing}
# ~35/2 with different comment counts per docket 
# ~325/2 with different titles per docket 
# ~98/2 with different related RINS / lowest related rin per docket 
# 115/2 with different docket_urls

# missing related RINs
rin_lookup %>% 
  select(# title, 
    docket_id,
    RIN.directory, RIN.lookup,
         related.rins, 
         lowest.sorted.rin.of.related.rins, 
         docket_url.directory, docket_url.lookup,
             comment_count) %>%
  distinct() %>% 
  filter(is.na(related.rins)) %>% 
  kablebox()
```

## Dockets with more than one RIN

```{r rin-lookup}
rin_lookup %>% 
  select(# title, 
    docket_id,
    RIN.directory, RIN.lookup,
         related.rins, 
         lowest.sorted.rin.of.related.rins, 
         docket_url.directory, docket_url.lookup,
             comment_count) %>%
  distinct() %>% 
  filter(!is.na(related.rins)) %>% 
  add_count( docket_id) %>%
  arrange(docket_id) %>% 
  filter(n > 1) %>%   
  distinct() %>% 
  kablebox()

rin_lookup %<>% 
  select(-RIN.directory,
         -docket_url.directory) %>% distinct()

names(rin_lookup) %<>% str_remove(".lookup")
```

---

## Asset data

Summary table data here: 

```{r docket_table, fig.height=5.5, fig.width=5.4, out.width="80%"}
# clean match data from finreg_commenter_covariates
docket_table <- read_csv(here::here("data", "matches_per_docket.csv"))


docket_table %>% 
  add_count(Agency) %>% 
  mutate(Agency = paste(n, "dockets from", Agency)) %>% 
  select(- Percent, - Docket, -`Any Resources Measure`) %>% 
  group_by(Agency) %>% 
  summarise_all(sum) %>% 
  group_by(Agency) %>% 
  pivot_longer(cols = c("Comments", contains(" ") ))  %>% 
  mutate(Matched = ifelse(name == "Comments", "Total","Matched"),
         name = ifelse(name == "Comments", "Total", name)) %>% 
  ggplot() + 
  aes(fill = name,
      y = Matched, 
      x = value) + 
    geom_col(position = "stack", alpha = .7) + 
  labs(x = "Comments", y = "", fill = "Resource\nData Type",
       title = "Comments Matched to Organizational Resources Data") + 
  facet_wrap("Agency", ncol = 1, scales = "free") + 
  theme(legend.position = "bottom",
        panel.grid.major.y = element_blank(),
        strip.text = element_text(size = 12)) 
  

docket_table %>% 
  knitr::kable() %>% 
  kable_paper(full_width = F) %>%
  column_spec(5, color = "white",
              background = spec_color(docket_table$Comments/ docket_table$`Any Resources Measure`, begin = .1, end = .9, direction = 1, option = 3) ) %>% 
  scroll_box(height = "400px")
```

```{r data-match-clean}
# clean match data from finreg_commenter_covariates
load(here("data", "match_data_clean.Rdata"))

match_data_clean %>% count(comment_agency)

d <- match_data_clean  
```

## By organization type 

```{r org_count_type, fig.width=5.5, fig.height=2.3}
d %<>% mutate(#org_comment = ifelse(is_likely_org == 1, "Likely Org", "Likely Not Org"),
              Agency = str_to_upper(comment_agency))

#d %<>% filter(is_likely_org == 1)

#FIXME changing this 
d %<>% mutate(org_type = best_match_type)

d %<>% mutate(Org_type = org_type %>% 
                str_replace("CIK", "Filed with SEC (CIK Data)") %>% 
                str_replace("Compustat", "Wharton Compustat Company Database") %>% 
                str_replace("FDIC", "FDIC-Insured Bank") %>% 
                str_replace("Nonprofit", "Nonprofit (IRS Data)") %>% 
                str_replace("FFIEC", "FFIEC Bank/Bank-like Entity") %>% 
                str_replace("OpenSecrets", "PAC Donor (CRP Data)"))

# comments 
d %>% group_by(Agency, Org_type) %>% 
  count() %>% 
  ggplot() +
  aes(x = Agency, y = n, fill = Org_type) + 
  geom_col() + 
  labs(fill = "Type of Organanization",
       y = "Number of Comments")


# using best_match_type instead of org_type
#FIXME WHY IS THERE A DIFFERENCE
# d %>% 
#   mutate(Agency = str_spl(comment_agency, "\\|"),
#          org_type = Best_match_type %>% str_remove("_.*")) %>% 
#   unnest(Agency) %>%
#   group_by(Agency, org_type) %>% 
#   count() %>% 
#   ggplot() +
#   aes(x = Agency, y = n, fill = org_type) + 
#   geom_col() + 
#   #facet_wrap("org_comment", scales = "free") +
#   labs(fill = "Type of Organanization",
#        y = "Number of Comments")

# unique orgs 
d %>% nrow() 

d %>% distinct(org_name) %>% nrow() 

d %>% distinct(Agency, Org_type, org_name) %>% 
  group_by(Agency, Org_type) %>% 
  count() %>%
  ggplot() +
  aes(x = Agency, y = n, fill = Org_type) + 
  geom_col() + 
  labs(fill = "Type of Organanization",
       y = "Number of Organizations")


org_count_agency <- d %>% 
  count(org_name, org_type, org_resources, Agency)

org_count <- d  %>% 
  count(org_name, org_type, org_resources)
```

---

## Comments per docket

```{r rins-table}
d_rin_lookup <- d %>% full_join(rin_lookup) %>% 
  distinct(docket_id,
         #  RIN,
         related.rins, 
         lowest.sorted.rin.of.related.rins, 
         #docket_url,  
         comment_count,
         comment_url) %>% 
  group_by(docket_id) %>%
  mutate(comments_matched = sum(!is.na(comment_url) ) ) %>% 
  mutate(comment_count = as.numeric(comment_count)) %>% 
  select(docket_id, comment_count,comments_matched, everything()) %>% 
  arrange(docket_id) %>% 
  filter(!is.na(docket_id))

d_rin_lookup  %>% 
  select(-comment_url) %>% 
  distinct() %>% 
  #filter(comments_matched > 0)
  kablebox()
```

Some of these appear to be over-matched, but it is also possible that the comment counts are wrong. 

```{r rins-table-comments-counts}
# 6 over matched 
d_rin_lookup %>% 
  filter(comment_count < comments_matched) %>%
  #arrange(comment_url) %>% 
  select(-comment_url) %>% 
  distinct() %>% 
  kablebox()
```

---

### Payday loan rule

The payday loan rule accounts for 90% of credit union comments and 50% of nonprofit comments, and 75% of open secrets matched comments in the current data.
15% of nonprofits and 30% of opensecrets matches commented only on the payday loan rule

```{r org_count_type-payday, fig.width=7.5, fig.height=2.5}
d %<>% mutate(payday = ifelse(str_detect(comment_url, "CFPB-2016-0025|CFPB-2019-0006"), "Payday Loan Rules", "All Other Rules"))

d %>% group_by(Agency, Org_type, payday) %>% 
  count() %>% 
  ggplot() +
  aes(x = Agency, y = n, fill = Org_type) + 
  geom_col() + 
  labs(fill = "Type of Organanization",
       y = "Number of Comments") + 
  facet_wrap("payday")

# number of payday loan comments per org 
d %>% 
  #filter(payday == "Payday Loan Rules") %>% 
  count(comment_org_name, best_match_name, sort = T) %>% 
  kablebox() 

```

## Potential false matches

```{r false-matches}

false_match <- "nknown|private investor|private individual|self employed|american citizen|us citizen|advance america|b d | store 7|debt trap|financial 3|united states congress|lending bear|check city partnership|plan nevada|clarity services|title cash|st louis community credit union|antipoverty coalition greater dallas|faith fair lending|south carolina state senate|florida alliance consumer protection|minneapolis grain exchange|asset management group securities industry financial markets association|american title escrow|ssociation financial guaranty insurers|american financial services association|credit union association dakotas|working group commercial energy firms|center capital markets competitiveness|chelsea title nature coast|kendall county|california nevada credit union leagues|futures industry association fia|national rural electric cooperative association|pennsylvania housing finance agency|members congress|new york portfolio clearing|check city partnership|central title|committee on investment employee benefit assets|futures industry association|national association independent housing professionals"

# possible false positives
d %>% filter(str_detect(comment_org_name, false_match)) %>% nrow() %>% paste("potential false matches")

# false positive orgs 
d %>% filter(str_detect(comment_org_name, false_match)) %>% 
  count(comment_org_name, best_match_name, best_match_score, best_match_type, sort = T) %>% 
  #kable(format = "markdown")
  kablebox()

# false positive comments 
d %>% filter(str_detect(comment_org_name,  false_match)) %>% 
  select(#starts_with("docket"), 
    starts_with("comment"),
         starts_with("best"), everything() ) %>% 
  select(-comment_docket_count, -comment_agency) %>% 
  kablebox()


# drop false matches 
d %<>% filter(!str_detect(comment_org_name, false_match))


d %>% 
  filter(str_detect(best_match_name, "financial")) %>% 
  arrange(-org_comments) %>% 
  select(org_comments, comment_org_name,  best_match_name, best_match_score, best_match_type, comment_url, everything()) %>% 
  kablebox()
```

---



## Commenters matched to other datasets of known organizations

```{r match_data}
# 2k
 paste("Credit Union matches: ", sum(!is.na(d$CreditUnions_name)) )

d %>% filter(!is.na(CreditUnions_name)) %>% select(ends_with("name"), comment_url) %>% kablebox()

# 5k
 paste("CIK matches: ", sum(!is.na(d$CIK_name)) )

d %>% filter(!is.na(CIK_name)) %>% select(ends_with("name"), comment_url)  %>% kablebox()

# 1k
 paste("FDIC_Institutions matches: ", sum(!is.na(d$FDIC_Institutions_name)) )

d %>% filter(!is.na(FDIC_Institutions_name)) %>% select(ends_with("name"), comment_url) %>% kablebox()

# 0
 paste("FFIECInstitutions matches: ", sum(!is.na(d$FFIECInstitutions_name)) )

#d %>% filter(!is.na(FFIECInstitutions_name)) %>% select(ends_with("name")) %>% kablebox()

# 18k
 paste("NonProfitTax matches: ", sum(!is.na(d$nonprofits_resources_name)) )

d %>% filter(!is.na(nonprofits_resources_name)) %>% select(ends_with("name"), comment_url) %>% kablebox()

# 4k
 paste("OpenSecrets matches: ", sum(!is.na(d$opensecrets_resources_name)) )

d %>% filter(!is.na(opensecrets_resources_name)) %>% select(ends_with("name"), comment_url) %>% kablebox()


# 0
 paste("SEC matches: ", sum(!is.na(d$SEC_Institutions_name)))

# d %>% filter(!is.na(SEC_Institutions_name)) %>% select(ends_with("name"))  %>% kablebox()
 

```

Example URLs
```{r, eval=FALSE}
#Example urls

d %>% group_by(comment_agency) %>% 
  slice(1) %>% 
  select(comment_url) 
```

---

#  By organization resources

---

## By Assets

(FDIC data)

### Among firms that commented on a Dodd-Frank rule

```{r fdic-comment-counts, fig.width=4, out.width= "50%"}
max <- org_count %>%   filter(org_type == "FDIC") %>% pull(n) %>% max()

org_count %>% 
  filter(org_type == "FDIC") %>% 
  ggplot() +
  aes(x = org_resources,
      y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() +
  labs(x = "Assets",
       y = "Number of Comments") +
  lims(y =c(0, max))+ 
  scale_x_log10(breaks = breaks_log())

# by agency
max <- org_count_agency %>%   filter(org_type == "FDIC") %>% pull(n) %>% max()

org_count_agency %>% 
  filter(org_type == "FDIC") %>% 
  ggplot() +
  aes(x = org_resources,
      y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() +
  labs(x = "Assets",
       y = "Number of Comments") +
  lims(y =c(0, max)) + 
    facet_wrap("Agency") + 
  scale_x_log10(breaks = breaks_log())
```

---

### Comparing firms that did and did not comment on Dodd-Frank rules


```{r FDIC-density, fig.height=1.5, fig.width=4, out.width="50%"}
#FDIC-density
# load(here("data", "FDIC_resources.Rdata"))

# CSVs for simplicity 
FDIC_resources <- read_csv(here::here("data", "merged_resources", "FDIC_Institutions.csv"))  %>%
  select(NAME, NAMEHCR, STALP, STNAME, BKCLASS, ASSET) %>% 
  mutate(org_name = str_to_lower(NAME)) %>% 
  mutate(commented = org_name %in% d$best_match_name | org_name %in% d$FDIC_Institutions_name)


FDIC_resources %>% 
  #filter(assets > 100) %>% 
  mutate(Commented = ifelse(commented, "Commented", "Did not comment")) %>%
  ggplot() + 
  aes(x = ASSET/1000000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "FDIC-Insured Banks",
       fill = "", y = "", x = "Assets (Millions)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
```

Counts
```{r FDIC-count, fig.height=3, fig.width=4, out.width="50%"}
# FDIC-count
FDIC_resources %<>% 
  mutate(Commented = ifelse(
    org_name %in% d$best_match_name,
    "Commented", 
    "Did not comment")) 

# Dropping banks with less than $100
FDIC_resources %<>%  filter(ASSET > 1000) 


FDIC_resources%>% 
  ggplot() + 
  aes(x = ASSET/1000000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "FDIC-Insured Banks",
       fill = "", y = "", x = "Assets (Millions)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

FDIC_resources %<>% 
  filter(#BKCLASS != "N", 
         BKCLASS != "OI") %>%
  group_by(Commented) %>% 
  mutate(mean_ASSET = mean(ASSET, na.rm =TRUE),
         median_ASSET = median(ASSET, na.rm =TRUE)) %>% 
  ungroup() %>% 
  group_by(Commented, BKCLASS) %>% 
  mutate(mean_ASSET_type = mean(ASSET, na.rm =TRUE),
         median_ASSET_type = median(ASSET, na.rm =TRUE)) %>% 
  ungroup() 

FDIC_resources %>% distinct(Commented, mean_ASSET, median_ASSET) %>% kable()

FDIC_resources %>% distinct(Commented, BKCLASS, mean_ASSET_type, median_ASSET_type) %>% arrange(BKCLASS) %>% kablebox()


FDIC_resources %>%
  filter(ASSET > 10) %>% 
  mutate(Commented = Commented %>% paste0(         
    "\n(median = $", round(median_ASSET, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET, 0) %>% prettyNum(big.mark = ","), ")")) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET/1000)) + 
    geom_vline( aes(xintercept = median_ASSET/1000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = "All U.S. FDIC-Insured Banks",fill = "", y = "", x = "Assets (Thousands)") + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

---

#### National Associations

I am dropping National Associations for now because we are not matching some important ones, including JP Morgan Chase, Wells Fargo, Bank of America, CitiBank, PNC BANK, Capital One, U.S. Bank, TD Bank, and Chase Bank. 

This appears to be caused by commenting organizations matching to other FDIC classes (SA, SM, NM) or other datasets (mostly CIK). If the latter, this will hopefully be fixed when we allow matches across datasets, but if it is the former, and we only allow one match per dataset (as is appropriate), then we might need to think more about the best approach to matching these, perhaps selecting by largest assets.  

```{r FDIC-count-national-association, fig.height=3, fig.width=4, out.width="50%"}
#FDIC-count-national-association 

# class N
FDIC_resources %>% filter(BKCLASS == "N") %>% distinct(org_name, ASSET, Commented) %>% arrange(-ASSET) %>% kablebox()

# jpmorgan and wells fargo banks 
FDIC_resources %>% filter(str_detect(org_name, "jpmorgan|wells fargo|^bank of america|capital one|td bank|chase bank")) %>% distinct(BKCLASS, org_name, ASSET, Commented) %>% arrange(-ASSET) %>% kablebox()

# orgs in the comment data
d %>% filter(str_detect(org_name, "jpmorgan|wells fargo|^bank of america|capital one|td bank|chase bank")) %>% distinct(org_name, best_match_type, `FDIC_Institutions-bestMatch:ASSET`) %>% 
  kablebox()


FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("N")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
  scale_x_log10() + 
  labs(title = "FDIC-Insured National Associations",fill = "", y = "", x = "Assets (Thousands)") + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```


### FDIC instituttions

Now omitting class national associations and foreign banks (Class IO are foreign banks and did not comment)

```{r FDIC-density-select, fig.height=1.5, fig.width=4, out.width="50%"}
#FDIC-density-select

FDIC_resources %<>% 
  filter(BKCLASS != "N", 
         BKCLASS != "OI") %>%
  group_by(Commented) %>% 
  mutate(mean_ASSET = mean(ASSET, na.rm =TRUE),
         median_ASSET = median(ASSET, na.rm =TRUE)) %>% 
  ungroup() %>% 
  group_by(Commented, BKCLASS) %>% 
  mutate(mean_ASSET_type = mean(ASSET, na.rm =TRUE),
         median_ASSET_type = median(ASSET, na.rm =TRUE)) %>% 
  ungroup() 


# density plot without N and OI
FDIC_resources %>% 
  #filter(assets > 100) %>% 
  mutate(Commented = ifelse(commented, "Commented", "Did not comment")) %>%
  ggplot() + 
  aes(x = ASSET/1000000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "FDIC-Insured Banks",
       fill = "", y = "", x = "Assets (Millions)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
```

```{r FDIC-count-select, fig.height=3, fig.width=4, out.width="50%"}

FDIC_resources %>% distinct(Commented, mean_ASSET) %>% kable()

FDIC_resources %>%
  filter(ASSET > 10) %>% 
  mutate(Commented = Commented %>% paste0(         
    "\n(median = $", round(median_ASSET, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET, 0) %>% prettyNum(big.mark = ","), ")")) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET/1000)) + 
    geom_vline( aes(xintercept = median_ASSET/1000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = "U.S. FDIC-Insured Banks",fill = "", y = "", x = "Assets (Thousands)",
       caption = "Omits foreign banks and national associations") + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

```{r FDIC-count-by-class, fig.height=3,  fig.width=4, out.width="49%"}
FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("NM")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
    geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
  scale_x_log10() + 
  labs(title = "FDIC-Insured Commercial Banks",fill = "", y = "", x = "Assets (Thousands)") + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")

FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SB")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
    ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
  scale_x_log10() + 
  labs(title = "FDIC-Insured Savings Banks",fill = "", y = "", x = "Assets (Thousands)") + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")


FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SM")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
    ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
scale_x_log10() + 
  labs(title = "FDIC-Insured State Banks",fill = "", y = "", x = "Assets (Thousands)") + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")

FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SA")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
    ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
scale_x_log10() + 
  labs(title = "FDIC-Insured Savings Associations",fill = "", y = "", x = "Assets (Thousands)") + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```


```{r fdic-map}
states <- map_data("state")

FDIC_state_n <- FDIC_resources %>% 
  mutate(region = STNAME %>% str_to_lower()) %>% 
  group_by(region) %>% 
  summarise(n = n() )

states %>% 
  left_join(FDIC_state_n) %>% 
  ggplot() +
  aes(long, lat, group = group, fill = n) +
  geom_polygon(color = "white") + 
  labs(fill = "FDIC-Insured Banks") +
  theme_void()


FDIC_state_n <- FDIC_resources %>% 
  mutate(region = STNAME %>% str_to_lower()) %>% 
  group_by(region) %>% 
  summarise(n = sum(Commented == "Commented"))

states %>% 
  left_join(FDIC_state_n) %>% 
  ggplot() +
  aes(long, lat, group = group, fill = n) +
  geom_polygon(color = "white") + 
  labs(fill = "FDIC-Insured Banks \nCommenting On\n Dodd-Frank Rules") +
  theme_void()


```


---

### Among nonprofits that commented on Dodd-Frank rules

```{r nonprofit-comment-counts, fig.height=1.5, fig.width=4, out.width="50%"}
load(here("data", "nonprofit_resources.Rdata"))

# make unique ( there are nearly 5k different rotary internationals, and sevarl APIs )
# select org entry with highest assets 
nonprofit_resources %<>% group_by(org_name) %>% 
  top_n(1, assets) %>% 
  ungroup()

nonprofit_resources %>% 
  filter(org_name %in% d$best_match_name) %>% 
  #filter(commented, assets > 100) %>% 
  ggplot() + 
  aes(x = assets, y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() + 
    labs(x = "Assets",
       y = "Number of Comments") +
  scale_x_log10()


nonprofit_resources %>% 
    filter(org_name %in% d$best_match_name) %>% 
  filter(commented, assets > 100) %>% 
  ggplot() + 
  aes(x = revenue, y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() + 
    labs(x = "Revenue",
       y = "Number of Comments") +
  scale_x_log10() 
```

---

### Comparing nonprofits that did and did not comment on Dodd-Frank rules

```{r nonprofit-density, fig.height= 1.5, fig.width=4, out.width="50%"}
# counts 
nonprofit_resources %<>% 
  mutate(Commented = ifelse(
    org_name %in% d$best_match_name,
    "Commented", 
    "Did not comment")) 

# density plots 
nonprofit_resources %>% 
  filter(assets > 10) %>% 
  ggplot() + 
  aes(x = assets/1000000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Nonprofits",
       fill = "", y = "", x = "Assets (Millions)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

nonprofit_resources %>% 
  #filter(assets > 100) %>% 
  ggplot() + 
  aes(x = revenue, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(fill = "", y = "", x = "Revenue",
       title = "Nonprofits") +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())



nonprofit_resources %<>% 
  group_by(Commented) %>% 
  mutate(mean_assets = mean(assets, na.rm = T),
         median_assets = median(assets, na.rm = T),
         mean_revenue = median(revenue, na.rm = T)) %>% 
  ungroup()

nonprofit_resources %>% distinct(Commented, mean_assets, mean_revenue) %>% kable


# mean assets
mean_commented <- nonprofit_resources %>% filter(Commented == "Commented") %>% distinct(mean_assets/1000000) %>% round(1) %>%  paste("million")

mean_not_commented <- nonprofit_resources %>% filter(Commented != "Commented") %>% distinct(mean_assets/1000000) %>% round(1) %>%  paste("million")

# median assets
median_commented <- nonprofit_resources %>% filter(Commented == "Commented") %>% distinct(median_assets/1000000) %>% round(2) %>%  paste("million")

median_not_commented <- nonprofit_resources %>% filter(Commented != "Commented") %>% distinct(median_assets/1000000) %>% round(2) %>%  paste("million")
```


Nonprofits that commented on Dodd-Frank rules had an average of `r mean_commented` in assets, while nonprofits that did not comment averaged `r mean_not_commented`.

The median nonprofits that commented on Dodd-Frank rules had assets of `r median_commented` in assets, while the median nonprofit that did not comment had `r median_not_commented`.

```{r nonprofit-count, fig.height=3, fig.width=4, out.width="50%"}
#nonprofit-count  histograms 
nonprofit_resources %>% 
  filter(assets > 10) %>% 
  mutate(Commented = Commented %>% paste(
    "\n(median = $", round(median_assets/10000000, 2), " million, ",
    "mean = $", round(mean_assets/10000000, 1), " million)"
    )) %>% 
  ggplot() + 
  aes(x = assets/1000000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_assets/1000000)) + 
      geom_vline( aes(xintercept = median_assets/1000000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = "Nonprofits",fill = "", y = "", x = "Assets (Millions)") + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")


nonprofit_resources %>% 
  filter(revenue > 10) %>% 
  ggplot() + 
  aes(x = revenue/1000, fill = Commented, label = mean_revenue) + 
  geom_histogram(alpha = .5, color = NA) + 
    geom_vline( aes(xintercept = mean_revenue/1000)) + 
  scale_x_log10() + 
  labs(title = "Nonprofits",fill = "", x = "Revenue ($1,000s)")+ 
  facet_grid(Commented ~ ., scales = "free_y")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_blank(),
  strip.text.y = element_blank())

# CHARTS 
# - who comments, who does not 
# - 


# TODO 
# - biggest nonprofits by assets and revenue (e.eg. chamber )
# - compartaitve ratios at key levels
# - percent nonprofits 
# - side by side histograms
# missing fed in matching, but could compare FDIC regulator to agency commented on
# - scholzman and verba, gilens and bartels 
```

### Comparing credit unions that did and did not comment on Dodd-Frank rules


```{r creditunion-density, fig.height= 1.5, fig.width=4, out.width="50%"}
#creditunion-density

#load the full population of campaign donors 
creditunions <- read_csv(here("Data" , "creditunions.csv") %>% str_remove("finreg/") )

creditunions %<>% 
  group_by(CU_NAME) %>% 
  top_n(1, `Total Assets`) %>% 
  ungroup()

creditunions %<>% mutate(org_name = tolower(CU_NAME),
                         assets = `Total Assets`,
                         commented = org_name %in% d$best_match_name,
                         Commented = ifelse(commented, "Commented", "Did not comment"))



# density plots 
creditunions %>% 
  filter(assets > 10) %>% 
  ggplot() + 
  aes(x = assets/1000000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(fill = "", x = "Assets (Millions)", title = "Credit Unions", fill = "", y = "")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

```


```{r creditunion-count, fig.height= 3, fig.width=4, out.width="50%"}
# creditunion-count 
creditunions %<>% 
  group_by(Commented) %>% 
  mutate(mean_assets = mean(assets, na.rm = T),
         median_assets = median(assets, na.rm = T) ) %>% 
  ungroup()

creditunions %>% distinct(Commented, mean_assets) %>% kable


# count histograms 
creditunions %>% 
    filter(assets > 100000) %>% 
  mutate(Commented = Commented %>% paste0(
    "\n(median = $", round(median_assets/1000000, 0), " million, ",
    "mean = $", round(mean_assets/1000000, 0), " million)"
    )) %>% 
  ggplot() + 
  aes(x = assets/1000000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_assets/1000000)) + 
    geom_vline( aes(xintercept = median_assets/1000000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = "Credit Unions",fill = "", y = "", x = "Assets (Millions)") + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```



---

## By Lobbying Spending

(OpenSecrets data)

```{r opensecrets-density, fig.height=1.5, fig.width=4, out.width="50%"}
#opensecrets-density

#load the full population of campaign donors 
opensecrets <- read_csv(here("data" , "merged_resources", 
"opensecrets_resources_JwVersion.csv") )




# indicator for whether they commented
opensecrets %<>% 
  mutate(org_name = orgName %>% str_to_lower(),
         Commented = ifelse(
    org_name %in% d$best_match_name,
    "Commented", 
    "Did not comment"))

# unique
opensecrets %<>% group_by(org_name) %>% 
  top_n(1, MeanContribAmount)

opensecrets %>% 
  group_by(Commented) %>% 
  summarise(mean_MeanContribAmount = mean(MeanContribAmount, na.rm = T),
            mean_MeanContribAmountPerYearContributed = mean(MeanContribAmountPerYearContributed, na.rm = T),
            MeanTotalContribAmount = mean(TotalContribAmount, na.rm = T)) %>% 
  kable()

opensecrets %>% 
  #filter(assets > 10) %>% 
  ggplot() + 
  aes(x = MeanContribAmount/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(fill = "",  
       y = "",
       title = "Campaign Spending",
       x = "Mean Contribution
       ($1,000s, in years contributing 2010-2017)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

opensecrets %>% 
  #filter(assets > 10) %>% 
  ggplot() + 
  aes(x = MeanContribAmountPerYearContributed/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Campaign Spending",
       fill = "", 
       y = "",
       x = "Mean Contribution per Year\n($1,000s, 2010-2017)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

opensecrets %>% 
  #filter(assets > 10) %>% 
  ggplot() + 
  aes(x = TotalContribAmount/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(fill = "", 
       title = "Campaign Spending",
       y = "",
       x = "Total Contributions\n($1,000s, 2010-2017)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
```


```{r opensecrets-count, fig.height= 3, fig.width=4, out.width="50%"}
# opensecrets-count 
opensecrets %<>% 
  group_by(Commented) %>% 
  mutate(mean_MeanContribAmount = mean(MeanContribAmount, na.rm = T),
         median_MeanContribAmount = median(MeanContribAmount, na.rm = T) ) %>% 
  ungroup()

opensecrets %>% distinct(Commented, mean_MeanContribAmount) %>% kable


# count histograms
opensecrets %>% 
    filter(MeanContribAmount > 100) %>% 
  mutate(Commented = Commented %>% paste0(
    "\n(median = $", round(median_MeanContribAmount/1000, 2), " million, ",
    "mean = $", round(mean_MeanContribAmount/1000, 1), " million)"
    )) %>% 
  ggplot() + 
  aes(x = MeanContribAmount/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_MeanContribAmount/1000)) + 
    geom_vline( aes(xintercept = median_MeanContribAmount/1000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = "Campaign Spending",fill = "", y = "", x = "Political Action Committee Donations (Thousands)") + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

---

## By Market Cap

(Computstat data)

```{r compustat-density, fig.height=1.5, fig.width=4, out.width="50%"}
compustat <- read_csv(here("data/merged_resources/compustat_resources.csv"))

#TODO CIK NOW HAS MATCHES, SHOULD BE COMBINED HERE 

compustat %<>% 
  mutate(org_name = conm %>% str_to_lower(),
         Commented = ifelse(
    org_name %in% d$best_match_name,
    "Commented", 
    "Did not comment")) %>% 
  mutate(marketcap2 = ifelse(str_detect(marketcap, "k"),
                             marketcap %>% str_remove("k") %>% as.numeric() * 1000,
                             marketcap),
         marketcap2 = ifelse(str_detect(marketcap, "M"),
                             marketcap %>% str_remove("M") %>% as.numeric() * 1000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "B"),
                             marketcap %>% str_remove("B") %>% as.numeric() * 1000000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "T"),
                             marketcap %>% str_remove("T") %>% as.numeric() * 1000000000000,
                             marketcap2),
         marketcap2 = marketcap2 %>% str_remove(",") %>%  as.numeric(marketcap2))

#compustat %>% filter(is.na(marketcap2), !is.na(marketcap)) %>% pull(marketcap)

# unique
compustat %<>% group_by(org_name) %>% 
  top_n(1, marketcap2) %>% 
  ungroup() 

compustat %>% 
  group_by(Commented) %>%
  filter(marketcap2 > 1000) %>% 
  ggplot() + 
  aes(x = marketcap2/1000000, fill = Commented) + 
  labs(fill = "", 
       y = "",
       title = "Banks and Bank-like Entities",
       x = "Market Capitalization (Millions)") + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  #geom_vline(aes(xintercept = mean)) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
```

```{r compustat-count, fig.height= 3, fig.width=4, out.width="50%"}
# compustat-count 
compustat %<>% 
  group_by(Commented) %>% 
  mutate(mean_marketcap2 = mean(marketcap2, na.rm = T),
         median_marketcap2 = median(marketcap2, na.rm = T) ) %>% 
  ungroup()

compustat %>% distinct(Commented, mean_marketcap2) %>% kable


# count histograms
compustat %>% 
    filter(marketcap2 > 1000) %>% 
  mutate(Commented = Commented %>% paste0(
    "\n(median = $", round(median_marketcap2/1000000, 2), " million, ",
    "mean = $", round(mean_marketcap2/1000000, 1), " million)"
    )) %>% 
  ggplot() + 
  aes(x = marketcap2/1000000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_marketcap2/1000000)) + 
    geom_vline( aes(xintercept = median_marketcap2/1000000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = "Banks and Bank-like Entities",fill = "", y = "", x = "Market Cap (Millions)") + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

## Temporarily merging in data where matches are NA

```{r merge}
#FIXME 
# TO GET NON-COMMENTERS, WE NEED TO JOIN IN THE OTHERS, BUT WE MIGHT NOT NEED THIS?
# Until the asset data are fixed to include matches in multiple datasets. 
d %<>% left_join(opensecrets %>% select(org_name, MeanContribAmount, TotalContribAmount)  ) %>%
  left_join(nonprofit_resources %>% select(org_name, assets, revenue) ) %>%
  left_join(compustat %>% select(-index) %>% select(org_name, marketcap, naics) ) %>% 
  left_join(creditunions %>% select(org_name, `Total Assets`))

d %<>% distinct()

##### 
# Instead, just keeping d limited to commenters and using matched data vars 

# requires renaming to align with above (and analysis code below)

# COMBINE matched and unmatched opensecrets 
d %<>% mutate(
  MeanContribAmount = coalesce(
    `opensecrets_resources_jwVersion-bestMatch:MeanContribAmountPerYearContributed`, # matched 
    MeanContribAmount # from opensecrets 
    ),
  TotalContribAmount = coalesce(
    `opensecrets_resources_jwVersion-bestMatch:TotalContribAmount`, # matched 
    TotalContribAmount     # from open secrets 

    )
)


# combine matched and unmatched nonprofits 
d %<>% mutate(
  assets = coalesce(`nonprofits_resources-bestMatch:assets`, #matched
                    assets, # from nonprofits
                    `Total Assets` # from credit unions 
                    ),
  revenue = coalesce(`nonprofits_resources-bestMatch:revenue`, #matched 
                     # from nonprofits
                     revenue)
)

# combine matched and unmatched marketcap
d  %<>% 
  mutate(marketcap = coalesce(
    `CIK-bestMatch:marketcap`, 
    `compustat_resources-bestMatch:marketcap`,
    marketcap),
         marketcap2 = ifelse(str_detect(marketcap, "k"),
                             marketcap %>% str_remove("k") %>% as.numeric() * 1000,
                             marketcap),
         marketcap2 = ifelse(str_detect(marketcap, "M"),
                             marketcap %>% str_remove("M") %>% as.numeric() * 1000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "B"),
                             marketcap %>% str_remove("B") %>% as.numeric() * 1000000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "T"),
                             marketcap %>% str_remove("T") %>% as.numeric() * 1000000000000,
                             marketcap2),
         marketcap2 = marketcap2 %>% str_remove(",") %>%  as.numeric(marketcap2))


```


We have market cap for  `r d %>% filter(!is.na(marketcap)) %>% count(best_match_name)  %>% nrow()` firms that submitted `r nrow(d %>% filter(!is.na(marketcap)))` comments.
```{r marketcap-inspect}
# fishy
d %>% 
  ggplot() +
  aes(x = marketcap2) + 
  geom_histogram()

d %>% arrange(-marketcap2) %>% count(marketcap, marketcap2, best_match_name, sort = T) %>% filter(!is.na(marketcap))

# unique(d$marketcap)
```



---

## Duplicates

(more than one match per comment URL)

Orgs in multiple states were one problem. For example, the API incorporated in DC has \$128,273,933 in assets while API in TX has \$15,368. Yale University had \$27,801,734,697 in assets (must include the endowment), and another Yale University had $4,858,646, both in CT.

```{r duplicates}

d %<>% distinct()
# duplicates
d %>% 
  add_count(comment_url, name = "n_per_url", sort = T) %>% 
  ungroup() %>% 
  filter(n_per_url > 1) %>% distinct() %>% 
  arrange(comment_url) %>%
  kablebox()
```

We solved this by selecting the entry with the highest assets. For example, the API now only matches the API's DC location. 

However, in the prior version of the data, the American Petroleum Institute and Yale University were both matched to nonprofit asset data and to opensecrets. Now, Yale Law has opensecrets data but no asset data, while API has asset data but no campaign donations. Yale University has neither---it is matched in CIK data, but its marketcap is NA, so we now have nothing for it. 

```{r}
d %<>% distinct()

d %>% filter(str_detect(best_match_name, "petroleum inst|yale uni")) %>% # view
  select(comment_url, best_match_name, 
         assets, 
         `nonprofits_resources-bestMatch:assets`, 
         `nonprofits_resources-bestMatch:revenue`,
         `nonprofits_resources-bestMatch:ein`,
         opensecrets_resources_name,
         MeanContribAmount,
         CIK_name,
         `CIK-bestMatch:marketcap`) %>% 
  kablebox()
```

<!--
But we still have almost as many duplicates when we drop `state`, partially because assets vary for the same "org" registered in different states: 

```{r duplicates2, eval = FALSE }
# duplicates after removing state
d %>% 
  select(-state) %>%
  add_count(comment_url, name = "n_per_url") %>% 
  ungroup() %>% 
  filter(n_per_url > 1) %>% distinct() %>% 
  arrange(comment_url) %>%
  kablebox()
```

--> 

# Asset data coverage by docket

```{r}
is_not_na <- . %>% is.na() %>% isFALSE()


dtable <- d_rin_lookup %>%
  ungroup() %>% 
  full_join(d %>% select(docket_id, comment_url, ends_with("_name"))) %>%
  ungroup() %>% 
  # add_count(docket_id) %>% 
  group_by(comment_url) %>% 
  mutate(across(ends_with("name"), is_not_na)) %>% 
  mutate(asset_data_name = sum( CIK_name, CreditUnions_name, FDIC_Institutions_name,	FFIECInstitutions_name,	SEC_Institutions_name,	compustat_resources_name,	nonprofits_resources_name) > 0#,
         #unique_orgs_name = org_name %>% unique() %>% length() 
         ) %>% 
  select(docket_id, comment_count, comments_matched, lowest.sorted.rin.of.related.rins,related.rins,
         comment_url, ends_with("_name")) %>% 
  distinct() %>% 
  group_by(docket_id, comment_count, comments_matched, lowest.sorted.rin.of.related.rins,related.rins) %>% 
  # tally up matches
  summarise(across(ends_with("name"), sum)) %>% 
  # select vars for table 
  select(docket_id,  lowest.sorted.rin.of.related.rins,related.rins, comment_count, comments_matched, asset_data_name,
         #unique_orgs_name,
        nonprofits_resources_name,
         CIK_name, CreditUnions_name, FDIC_Institutions_name,	FFIECInstitutions_name,	SEC_Institutions_name,	compustat_resources_name) %>% 
  ungroup() %>%
  distinct() %>% 
  arrange(-asset_data_name) 



sum2 <- . %>% sum(na.rm = TRUE)

dtable %>% summarise(across(where(is.numeric), sum2)) %>% pivot_longer(everything(), names_to = "measure") %>% kable()
  
dtable %>% write_csv(here::here("data", "matches_per_rin.csv"))
```


## Save asset data
```{r save}
#FIXME ideally all edits to these data would be in clean_match_data
commenter_assets <- d

save(commenter_assets, file = here::here("data", "commenter_assets.Rdata"))
```


## Comments per rule

### Percent of comments by each organization type on any one rule
```{r}
# comments 
# of the matched sample 
# 90% of credit union comments, half of nonprofits, and 75% campaig
d %>% 
  mutate(docket_id = str_split(docket_id, ";")) %>% 
  unnest(docket_id) %>% 
    add_count(org_type, name = "dataset_total") %>% 
  count(org_type, docket_id, dataset_total, sort = T) %>%
  mutate(percent = percent( n / dataset_total , accuracy = 1)) %>% 
  kablebox()
```


### Percent of each organization type on any one rule

```{r}
# orgs (15% of nonprifits on payday loan rule, 30% of opensecrets)
d %>% 
 mutate(docket_id = str_split(docket_id, ";")) %>% 
  unnest(docket_id) %>% 
  # org rather than comment level counts now
  distinct(org_name, docket_id, org_type) %>% 
  # total orgs of each type  in dataset 
  add_count(org_type, name = "dataset_total") %>% 
  # number of each org type by docket 
  count(org_type, docket_id, `dataset_total`, sort = T) %>%
  mutate(percent = percent( n / dataset_total , accuracy = 1)) %>% 
  kablebox()
```

### Most Frequently Commenting Orgs
```{r}
# 
d %>% 
  # filter(comment_agency == "CFPB") %>% 
  # mutate(docket_id = comment_url %>% str_extract("CFPB-[0-9]*-[0-9]*")) %>% 
  count(org_name, best_match_name, org_type, docket_id, sort = T) %>% kablebox()
```


# Regressions


## Probability of Commenting

These models have the prefix `mp_`. The dependent variable is the probability that the organization comments.

### FDIC-insured Banks

SM = Comptroller of the Currency (OCC). National Charter and a Fed member.

NM = Commercial Bank. The bank is supervised by the Federal Deposit Insurance Corporation (FDIC). State charter and Fed non-member

SB = Savings Bank. The bank is supervised by the Federal Deposit Insurance Corporation (FDIC). State Charter.

OI = Bank is an insured United States branch of a foreign chartered institution (IBA)

N = National Associations (Ommitted)

Assets in hundreds of millions

```{r cache=FALSE}
# FDIC_resources %>% filter(BKCLASS == "NM")

FDIC_resources %<>% mutate(Class = str_c(" ", BKCLASS) %>% as.factor() %>% relevel(ref = " SA"),
                           ASSETS = ASSET/100000000,
                           Assets = ASSET/1000000000) 
# %>% 
#   mutate(BKCLASS = BKCLASS %>% str_replace("^NM", "SBNM"))  %>% 
#   mutate(BKCLASS = BKCLASS %>% str_replace("^NM", "SBNM"))

unique(FDIC_resources$BKCLASS)


cm = c("ASSET" = "Assets",
       "ASSETS" = "Assets (Hundreds of Millions)",
       "Assets" = "Assets (Billions)",
       "Class SM" = "State Bank",
       "Class SB" = "Savings Bank",
       "Class SA" = "Savings Association",
       "Class NM" = "Commercial Bank",
       "ASSETS:Class SM" = "Assets x State Bank",
       "ASSETS:Class SB" = "Assets x Savings Bank",
       "ASSETS:Class SA" = "Assets x Savings Association",
       "ASSETS:Class NM" = "Assets x Commercial Bank")
```


```{r mpFDIC, cache=FALSE, fig.height=2, fig.width=6}
#mpFDIC
mpFDICbillions <- glm(commented ~ Assets,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC <- glm(commented ~ ASSETS,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC_BKCLASSonly <- glm(commented ~ Class,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC_BKCLASS <- glm(commented ~ ASSETS + Class,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDICxBKCLASS <- glm(commented ~ ASSETS*Class,
           data = FDIC_resources, 
             family=binomial(link="logit"))


rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Comment",
  `2` = "Comment",  
  `3` = "Comment"
)

attr(rows, 'position') <- c(0)

models <- list(mpFDIC,# mpFDIC_BKCLASSonly,
               mpFDIC_BKCLASS,
               mpFDICxBKCLASS)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

modelplot(models[1:2], coef_map = cm) +
  labs(title  = "FDIC-Insured Banks",
x = "Change in Log Odds of Commenting",
caption = "Reference Category = Savings Associations") +
  theme(panel.grid.major.x =  element_blank(),
        panel.grid.major.y =  element_blank()) + 
  scale_color_viridis_d(end = .6)
```


### Nonprofits

Assets in billions

```{r mp-nonprofits}
nonprofit_resources %<>% mutate(Assets = assets/1000000000)

mpNonprofit <- glm(commented ~ Assets,
           data = nonprofit_resources , 
             family=binomial(link="logit"))

mpNonprofit_revenue <- glm(commented ~ Assets + revenue,
           data = nonprofit_resources, 
             family=binomial(link="logit"))

models <- list(mpNonprofit, mpNonprofit_revenue)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Comment",
  `2` = "Comment",  
)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

modelplot(models)+ 
  theme(panel.grid.major.x =  element_blank()) + 
  labs(x = "Change in Log Odds of Commenting")
```

### Credit Unions

Assets in billions

 
```{r mp-credit-unions}
creditunions %<>% mutate(Assets = assets/100000000)


mp_creditunions <- glm(commented ~ Assets,
           data = creditunions, 
             family=binomial(link="logit"))

models <- list(mp_creditunions)


rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Commented",
)

attr(rows, 'position') <- c(0)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

modelplot(models)+ 
  theme(panel.grid.major.x =  element_blank()) + 
  labs(x = "Change in Log Odds of Commenting per Billion in Assets")
```

### Banks, Nonprofits, Credit Unions Compared

```{r mp-nonprofit-credit-unions}
# nonprofit-credit-unions
models <- list(mpFDICbillions, mpNonprofit, mp_creditunions)

names(models) <- c("FDIC-Insured Banks", "Nonprofits", "Credit Unions")


modelplot(models, coef_map = cm) + 
  theme(panel.grid.major.x =  element_blank()) + 
  labs(x = "Change in Log Odds of Commenting per Billion in Assets") +
  facet_wrap("model", scales = "free", ncol = 1)
```

### Campaign Donors

```{r mp-opensecrets}
opensecrets %<>% mutate(commented = Commented == "Commented")

mpOpensecrets <- glm(commented ~ MeanContribAmount,
           data = opensecrets, 
             family=binomial(link="logit"))

mpOpensecrets_total <- glm(commented ~ TotalContribAmount,
           data = opensecrets, 
             family=binomial(link="logit"))

models <- list(mpOpensecrets, mpOpensecrets_total)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Commented",
  `2` = "Commented"
)

attr(rows, 'position') <- c(0)


equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

# modelplot(models)
```

### By Market Cap
```{r mp-compustat}
compustat %<>% mutate(commented = Commented == "Commented",
                      marketcapB = marketcap2/1000000000)

cm = c("marketcapB" = "Market Capitalization (Billions)")

mpCompustat <- glm(commented ~ marketcapB,
           data = compustat, 
             family=binomial(link="logit"))

top_naics <- compustat %>% count(naics, sort = T) %>% 
  drop_na(naics) %>% 
  top_n(10, wt = n) %>% 
  pull(naics)

mpCompustat_naics <- glm(commented ~ NAICS_,
           data = compustat %>% mutate(NAICS_ = ifelse(naics %in% top_naics, naics, "other")), 
             family=binomial(link="logit"))

models <- list(mpCompustat, mpCompustat_naics)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

#modelplot(models)

 modelplot(mpCompustat)
 
# modelplot(mpCompustat_naics)
```

